<!DOCTYPE html>
<html>
<head>
	<script src="d3.v6.js"></script>
	<style>
		.hand {cursor: pointer;}
		.levelBtn
		{
			display:inline-block;margin:20px;border:1px solid black; padding:10px;font-weight:bold;
		}
		.levelBtnDisabled
		{
			pointer-events: none; 
			background-color: silver;
		}
	</style>
</head>
<body>
	<div id="levelButtons"></div>
	<div id="divGame">
		<b>Level <span id="spanLevel">1</span></b>
		<p>
			<label for="volume">Volume</label>
			<input type="range" id="volume" name="volume" min="0.5" max="15" value="5">
		</p>
		<p>
			Round: <span id="spanRound">0</span> / <span id="spanRounds">0</span><br>
			Score: <span id="spanScore">0</span>
		</p>
		<div id="divGuessButtons"></div>
	</div>

	<script type="module">
		// import surBujho code. Call it sbg
		import * as sbg from './sur-bujho7.js';
		import {cookie} from './cookie.js';

		globalThis.myCookie = new cookie("SBG1");
		globalThis.uiGame = {
				level: sbg.cLevels[0],
				levelNbr: 1,
				idLevelBtns: "levelButtons",
				idGame: "divGame",
				idGameLevel: "spanLevel",
				idRounds: "spanRounds",
				idRound: "spanRound",
				idScore: "spanScore",
				idGuessBtns: "divGuessButtons",
				fnClick: captureGuess,
				clLevelOpen: "levelBtn hand",
				clLevelClose: "levelBtn levelBtnDisabled",
			}

		globalThis.game;
		globalThis.gameUIController = new sbg.surBujhoUI(globalThis.uiGame);
		
		showLevelsScreen();

		function showLevelsScreen()
		{
			globalThis.myLastOpenLevel = parseInt(globalThis.myCookie.get("Level"));
			if (isNaN(globalThis.myLastOpenLevel))
			{
				globalThis.myLastOpenLevel = 1;
				globalThis.myCookie.set("Level",globalThis.myLastOpenLevel,365);
			}
			globalThis.gameUIController.makeLevelBtns(sbg.cLevels,globalThis.myLastOpenLevel,start);
		}

		// start the game
		function start(event,level)
		{
			globalThis.gameUIController.clearLevelBtns();

			let [x,levelNbr] = this.id.split("-");
			globalThis.uiGame.level = level;
			globalThis.uiGame.levelNbr = levelNbr;

			globalThis.gameUIController.initGameScreen(globalThis.uiGame);
			globalThis.game = new sbg.surBujhoGame(level);

			// create the guess buttons
			globalThis.gameUIController.makeGuessBtns(globalThis.game.round);
			// start the game
			globalThis.game.start();
		}
		function captureGuess(event,noteName)
		{
			// if it is a blank 
			if (noteName == "b") return;

			let result = globalThis.game.assessGuess(noteName);
			globalThis.gameUIController.markGuessResult(this,result.success,globalThis.game.score);
			if (result.success) {
				if (!result.end)
				{
					setTimeout(function() { 
						globalThis.gameUIController.clearGuessBtns();
						globalThis.gameUIController.makeGuessBtns(globalThis.game.round);
						globalThis.game.nextRound(); }, 
						1500);
				}
				else
				{
					let cookieid = "Level"+globalThis.uiGame.levelNbr+'Score';
					let rounds = globalThis.uiGame.level.gameRounds;
					let score = parseInt((game.score / rounds) * 100);
					globalThis.myCookie.set(cookieid,score,365);
					if (score == 100)
						globalThis.myCookie.set("Level",globalThis.myLastOpenLevel+1,365);
					showLevelsScreen();
				}
				
			};
		}
		
	</script>

</body>
</html>