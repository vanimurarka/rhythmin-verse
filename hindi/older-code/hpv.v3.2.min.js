function visualize(){splitNprocessPoem(),fFreeVerse&&initializeCompositeLines(),fGhazal&&(calculateRadeef(),calculateKaafiyaa()),draw(),document.getElementById("divControls").style.display="block"}function joinCharConsonantVowel(a,b){return a==b?b:"अ"==b?a:a+b}function calculateRadeef(){radeef="",radeefArray=[],radeefTruncated=0;for(var a,b,c,d,c=chars[0].length,d=chars[1].length,e=!1,f=c-1,g=d-1;!e&&f>=0&&g>=0;)a=joinCharConsonantVowel(chars[0][f][0],chars[0][f][1]),b=joinCharConsonantVowel(chars[1][g][0],chars[1][g][1]),a==b?(radeef=a+radeef,radeefArray[radeefArray.length]=[],radeefArray[radeefArray.length-1][0]=chars[0][f][0],radeefArray[radeefArray.length-1][1]=chars[0][f][1],f--,g--):e=!0;var h=radeef.substr(radeef.indexOf(" ")+1);if(radeef!==h){for(console.log("radeef truncated"),radeefTruncated=1,f=radeefArray.length-1;f>=0&&" "!=radeefArray[f][0];f--);radeefArray.length=f,radeef=h}for(var i=radeefArray.length,f=0;f<chars.length;f++){var j=!1;f<=1&&(j=!0),f>1&&f<chars.length-1&&0==chars[f+1].length&&(j=!0),f==chars.length-1&&(j=!0);var k=chars[f].length;if(j&&k>i)for(var g=0;g<i&&(radeefArray[g][0]==chars[f][k-1-g][0]&&radeefArray[g][1]==chars[f][k-1-g][1]);g++)chars[f][k-1-g][6]="r"}}function originalVowel(a){switch(a){case" ":case",":return" ";case"अ":return"अ";case"आ":case"ा":return"आ";case"इ":case"ि":return"इ";case"ई":case"ी":return"ई";case"उ":case"ु":return"उ";case"ऊ":case"ू":return"ऊ";case"ए":case"े":return"ए";case"ऐ":case"ै":return"ऐ";case"ओ":case"ो":return"ओ";case"औ":case"ौ":return"औ";case"ृ":return"ृ";default:return-1}return-1}function calculateKaafiyaa(){for(var c,d,e,a=radeefArray.length,b=!1,f=[],g=chars[0].length,h=chars[1].length,i=g-1-a,j=h-1-a;!b&&i>=0&&j>=0;)d=originalVowel(chars[0][i][1]),e=originalVowel(chars[1][j][1]),console.log(d),console.log(e),d==e?(c=d+c,f[f.length]=d,i--,j--):b=!0;" "==f[0]&&f.splice(0,1),console.log(f);for(var k=f.length,a=radeefArray.length,i=0;i<chars.length;i++){var l=!1;i<=1&&(l=!0),i>1&&i<chars.length-1&&0==chars[i+1].length&&(l=!0),i==chars.length-1&&(l=!0);var m=chars[i].length;if(l&&m>a+k+radeefTruncated)for(var j=0;j<k&&f[j]==originalVowel(chars[i][m-1-a-radeefTruncated-j][1]);j++)chars[i][m-1-a-radeefTruncated-j][6]="k"}}function initializeCompositeLines(){for(i=0;i<chars.length;i++)compositeLinesMarkingA[i]=[],chars[i].length>0?(compositeLinesMarkingA[i][0]=chars[i][chars[i].length-1][5],compositeLinesMarkingA[i][1]=!1):(compositeLinesMarkingA[i][0]=0,compositeLinesMarkingA[i][1]=!1)}function calculateCompositeLines(){var a=!1,b=[];if(chars.length>1)for(i=1;i<chars.length;i++)if(compositeLinesMarkingA[i][1])if(a){var c=b.length;b[c-1][1]+=chars[i][chars[i].length-1][5]}else{a=!0;var c=b.length;b[c]=[],b[c][0]=i-1,b[c][1]=chars[i-1][chars[i-1].length-1][5],b[c][1]+=chars[i][chars[i].length-1][5]}else a&&(a=!1);return b.length>0&&b}function splitNprocessPoem(){var a=document.getElementById("pom").value,b=a.split("\n"),c=prevText.split("\n"),d=0,e=0,f=0,g=0;for(maxLineLen=b.length,d=0;d<maxLineLen;d++)if(d<c.length&&c[d]==b[d])chars[d][chars[d].length]="old";else{for(chars[d]=[],e=0;e<b[d].length;e++)f=b[d].charCodeAt(e),g=chars[d].length,f>=2366&&f<=2381?(chars[d][g-1][1]=b[d].substring(e,e+1),chars[d][g-1][3]=getVowData(chars[d][g-1][1])):((32==f||44==f||f>=2309&&f<=2324)&&(chars[d][g]=["",""],chars[d][g][0]=b[d].substring(e,e+1),chars[d][g][1]=b[d].substring(e,e+1)),(f>=2325&&f<=2361||f>=2392&&f<=2399)&&(chars[d][g]=["",""],chars[d][g][0]=b[d].substring(e,e+1),chars[d][g][1]="अ"),2306==f&&(chars[d][g]=["",""],chars[d][g][0]=b[d].substring(e,e+1),chars[d][g][1]="्"),g=chars[d].length-1,chars[d][g][2]=getConsData(chars[d][g][0]),chars[d][g][3]=getVowData(chars[d][g][1]),chars[d][g][4]=0,chars[d][g][5]=0);chars[d][chars[d].length]="new"}for(d=0;d<chars.length;d++){if("new"==chars[d][chars[d].length-1]){for(e=0;e<chars[d].length-1;e++){switch(chars[d][e][3]){case 1:case 3:case 5:case 11:chars[d][e][4]=1;break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:chars[d][e][4]=2;break;case-1:0==e?e==chars[d].length-2?chars[d][e][4]=halfLetterLen(0,chars[d][e],0):chars[d][e][4]=halfLetterLen(0,chars[d][e],chars[d][e+1]):e==chars[d].length-2?chars[d][e][4]=halfLetterLen(chars[d][e-1],chars[d][e],0):chars[d][e][4]=halfLetterLen(chars[d][e-1],chars[d][e],chars[d][e+1])}0==e?chars[d][e][5]=chars[d][e][4]:chars[d][e][5]=chars[d][e-1][5]+chars[d][e][4]}chars[d].length>1&&chars[d][e-1][5]>maxLen&&(maxLen=chars[d][e-1][5])}chars[d].pop()}b.length<chars.length&&(chars.length=b.length),prevText=a}function getVowData(a){switch(a){case" ":case",":return-10;case"अ":return 1;case"आ":case"ा":return 2;case"इ":case"ि":return 3;case"ई":case"ी":return 4;case"उ":case"ु":return 5;case"ऊ":case"ू":return 6;case"ए":case"े":return 7;case"ऐ":case"ै":return 8;case"ओ":case"ो":return 9;case"औ":case"ौ":return 10;case"ृ":return 11;default:return-1}return-1}function getConsData(a){switch(a){case" ":case",":return-10;case"अ":case"आ":case"इ":case"ई":case"उ":case"ऊ":case"ए":case"ऐ":case"ओ":case"औ":return 0;case"क":case"ख":case"ख़":case"ग":case"घ":case"ग़":case"ङ":return 1;case"च":case"छ":case"ज":case"झ":case"ञ":case"ज़":return 2;case"ट":case"ठ":case"ड":case"ढ":case"ण":case"ड़":case"ढ़":return 3;case"त":case"थ":case"द":case"ध":case"न":case"ं":return 4;case"प":case"फ":case"ब":case"भ":case"म":case"फ़":return 5;case"य":case"र":case"ल":case"व":return 6;case"श":case"ष":case"स":case"ह":return 7;default:return-1}return-1}function conColor(a){var b="",c="0.7";switch(a){case 0:b="grey";break;case 1:b="rgb(255,0,0)",c="0.65";break;case 2:b="rgb(255,165,0)";break;case 3:b="rgb(255,255,0)";break;case 4:b="rgb(0,255,0)",c="1.0";break;case 5:b="rgb(0,220,255)",c="1.0";break;case 6:b="rgb(0,64,255)";break;case 7:b="rgb(143,0,255)";break;default:b="black"}return[b,c]}function styleCharBlock(a,b){if(a[3]===-10)return"display: none";var c="white",d="0.3",e=1,f="0.7";if("consonant"==b){var g=conColor(a[2]);c=g[0],f=g[1]}return"ghazal"==b&&a.length>6&&("r"==a[6]&&(c="rgb(0,220,255)",f="1.0"),"k"==a[6]&&(c="rgb(0,255,0)",f="1.0")),a[3]==-1&&0==a[4]&&(c="black",d="1",f="0.7"),"fill: "+c+"; fill-opacity: "+f+";stroke:black; stroke-width: "+e+"; stroke-opacity: "+d}function vowPath(a,b){var c="",d=(a[5]-a[4])*charW,e=charW*a[4],f=charH;switch(a[3]){case-1:0==a[4]&&(e=4,f=4,d-=2,c="M"+d+",0 L"+d+",-"+f+" L"+(d+e)+",-"+f+" L"+(d+e)+",0 z"),1==a[4]&&(c="M"+d+",0 L"+d+","+f+" L"+(d+e)+","+f+" L"+(d+e)+",0 z");break;case 1:case 2:case 11:c="M"+d+",0 L"+d+","+f+" L"+(d+e)+","+f+" L"+(d+e)+",0 z";break;case 3:c="M"+d+","+f+" L"+d+","+f/2+" L"+(d+e/2)+",0 L"+(d+e)+","+f/2+" L"+(d+e)+","+f+" z";break;case 4:c="M"+d+","+f+" L"+(d+e/2)+",0 L"+(d+e)+","+f+" z";break;case 5:c="M"+d+",0 L"+d+","+f/2+"A"+e/2+","+e/2+" 0 0,0 "+(d+e)+","+f/2+" L"+(d+e)+",0 z";break;case 6:c=e==charW?"M"+d+",0 A"+e/2+","+e+" 0 0,0 "+(d+e)+",0 z":"M"+d+",0 A"+e/2+","+e/2+" 0 0,0 "+(d+e)+",0 z";break;case 7:c="M"+d+",0 L"+d+","+f+" L"+(d+e)+","+f+" L"+(d+e)+","+f/2+" z";break;case 8:c="M"+d+",0 L"+d+","+f+" L"+(d+e)+","+f+" z";break;case 9:c="M"+d+","+f+" L"+d+","+f/2+"A"+e/2+","+f/2+" 0 0,1 "+(d+e)+","+f/2+" L"+(d+e)+","+f+" z";break;case 10:c="M"+d+","+f+" A"+e/2+","+f+" 0 0,1 "+(d+e)+","+f+" z";break;default:c="M"+d+",0 L"+d+","+f+" L"+(d+e)+","+f+" L"+(d+e)+",0 z"}return c}function adjustCharLen(){var a=parseInt(this.getAttribute("id").substring(4)),b=parseInt(this.parentNode.getAttribute("id").substring(5)),c=0;if(chars[b][a][3]%2==0||chars[b][a][3]>6&&chars[b][a][3]<11){if(1==chars[b][a][4]){for(chars[b][a][4]=2,c=a;c<chars[b].length;c++)chars[b][c][5]=chars[b][c][5]+1;return chars[b][c-1][5]>maxLen&&(maxLen=chars[b][c-1][5]),void draw()}if(2==chars[b][a][4]){for(chars[b][a][4]=1,c=a;c<chars[b].length;c++)chars[b][c][5]=chars[b][c][5]-1;return void draw()}}if(chars[b][a][3]==-1){if(0==chars[b][a][4]){for(chars[b][a][4]=1,c=a;c<chars[b].length;c++)chars[b][c][5]=chars[b][c][5]+1;return chars[b][c-1][5]>maxLen&&(maxLen=chars[b][c-1][5]),void draw()}if(1==chars[b][a][4]){for(chars[b][a][4]=0,c=a;c<chars[b].length;c++)chars[b][c][5]=chars[b][c][5]-1;return void draw()}}}function markCompositeLineTextDash(){var a=parseInt(this.parentNode.getAttribute("id").substring(5));a<compositeLinesMarkingA.length-1&&!compositeLinesMarkingA[a+1][1]&&(compositeLinesMarkingA[a+1][1]=!compositeLinesMarkingA[a+1][1],draw())}function unmarkCompositeLine(){var a=parseInt(this.parentNode.getAttribute("id").substring(5));a>0&&(compositeLinesMarkingA[a][1]=!compositeLinesMarkingA[a][1],draw())}function charTxtPos(a,b){var c=(a[5]-a[4])*charW,d=charW*a[4];return c+d/2}function charTxt(a){var b="";return a[2]!=-10&&(b=0==a[2]||1==a[3]?a[0]:a[0]+a[1]),b}function halfLetterLen(a,b,c){if(0===a)return 0;if(a[2]===-10)return 0;if(pLD="",nLD="","म"==b[0]&&"ह"==c[0])return 0;if("न"==b[0]&&"ह"==c[0])return 0;switch(a[3]){case 1:case 3:case 5:case 11:pLD="l";break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:pLD="d"}if("l"===pLD)return 1;switch(c[3]){case 1:case 3:case 5:case 11:nLD="l";break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:nLD="d"}return"d"===pLD&&"d"===nLD?1:0}function drawCompositeLine(a,b){if("x1"==a)return 0==b?charW*maxLen+2*charW:compositeLinesMarkingA[b][1]?charW*maxLen+2.3*charW:charW*maxLen+2*charW;if("y1"==a)return compositeLinesMarkingA[b][1]?fLineSpacing?-3:0:charH;if("styleSmall"==a)return 0==compositeLinesMarkingA[b][0]?"display:none;":"stroke:black;stroke-width:4;";if("styleMain"==a)return 0!=compositeLinesMarkingA[b][0]&&compositeLinesMarkingA[b][1]?"stroke:black;stroke-width:4;":"display:none;";if("styleCompositeLineMaatraa"==a){var c=parseInt(document.getElementById("baseCount").value);return c>0?b[1]%c==0?"fill:black":"fill:red":"fill:black"}if("compositeRemainderValue"==a){var c=parseInt(document.getElementById("baseCount").value);if(c>1){var d=b[1]%c;if(0!=d){var e=b[1]/c,f=parseInt(e),g=e-f;return g<=.5?"+"+d:"-"+((f+1)*c-b[1])}}return""}}function draw(){var a=d3.select("#chart");a.select("svg").remove();var b=a.append("svg").attr("width",function(){return fFreeVerse?charW*maxLen+120:charW*maxLen+100}).attr("height",maxLineLen*(charW+7)+(charW+7)+charW).attr("style","border: solid 1px #ddd;");if(fLineSpacing)var c=b.selectAll("g").data(chars).enter().append("svg:g").attr("transform",function(a,b){return"translate("+paddingLeft+","+(b*(charH+lineSpacing)+(charH+lineSpacing))+")"}).attr("id",function(a,b){return"gLine"+b});else var c=b.selectAll("g").data(chars).enter().append("svg:g").attr("transform",function(a,b){return"translate("+paddingLeft+","+(b*charH+charH)+")"}).attr("id",function(a,b){return"gLine"+b});c.selectAll("path").data(function(a){return a}).enter().append("path").attr("id",function(a,b){return"char"+b}).attr("style",function(a,b){return fGhazal?styleCharBlock(a,"ghazal"):styleCharBlock(a,"consonant")}).attr("d",function(a,b){return vowPath(a,b)}).attr("title",function(a,b){return a[0]+a[1]}).on("click",adjustCharLen),showText&&c.selectAll("text").data(function(a){return a}).enter().append("svg:text").attr("y",charH-2).attr("x",function(a,b){return charTxtPos(a)}).attr("class","graphText3").attr("text-anchor","middle").text(function(a){return charTxt(a)}),fFreeVerse?(c.append("svg:text").attr("y",charH).attr("x",function(a){return charW*maxLen+charW}).attr("class","graphText3").text(function(a){return a.length>0?a[a.length-1][5]:""}).on("click",markCompositeLineTextDash),c.append("svg:line").attr("x1",function(a,b){return charW*maxLen+2*charW}).attr("y1",function(a,b){return charH+2}).attr("x2",function(a){return charW*maxLen+2.3*charW}).attr("y2",charH+2).attr("style",function(a,b){return drawCompositeLine("styleSmall",b)}).on("click",markCompositeLineTextDash),c.append("svg:line").attr("x1",function(a,b){return drawCompositeLine("x1",b)}).attr("y1",function(a,b){return drawCompositeLine("y1",b)}).attr("x2",function(a){return charW*maxLen+2.3*charW}).attr("y2",charH+2).attr("style",function(a,b){return drawCompositeLine("styleMain",b)}).on("click",unmarkCompositeLine)):c.append("svg:text").attr("y",charH).attr("x",function(a){return charW*maxLen+charW}).attr("class","graphText3").text(function(a){return a.length>0?a[a.length-1][5]:""}),drawCompositeNumbers()}function drawCompositeNumbers(){if(fFreeVerse){var a=calculateCompositeLines(),b=d3.select("#chart"),c=b.select("svg");if(fLineSpacing){c.selectAll(".compositeCountT").data(a).enter().append("svg:text").attr("y",function(a){return a[0]*(charH+lineSpacing)+(charH+lineSpacing)+charH}).attr("x",function(a){return paddingLeft+8+charW*maxLen+2*charW}).attr("class","compositeCountT").attr("style",function(a){return drawCompositeLine("styleCompositeLineMaatraa",a)}).text(function(a){return a[1]}),c.selectAll(".compositeCountR").data(a).enter().append("svg:text").attr("y",function(a){return a[0]*(charH+lineSpacing)+(charH+lineSpacing)+charH+10}).attr("x",function(a){return paddingLeft+8+charW*maxLen+2*charW+20}).attr("class","compositeCountR").attr("style",function(a){return"fill:red;font-size:80%"}).text(function(a){return drawCompositeLine("compositeRemainderValue",a)})}else{c.selectAll(".compositeCountT").data(a).enter().append("svg:text").attr("y",function(a){return a[0]*charH+charH+charH}).attr("x",function(a){return paddingLeft+8+charW*maxLen+2*charW}).attr("class","compositeCountT").attr("style",function(a){return drawCompositeLine("styleCompositeLineMaatraa",a)}).text(function(a){return a[1]}),c.selectAll(".compositeCountR").data(a).enter().append("svg:text").attr("y",function(a){return a[0]*charH+charH+charH+10}).attr("x",function(a){return paddingLeft+8+charW*maxLen+2*charW+20}).attr("class","compositeCountR").attr("style",function(a){return"fill:red;font-size:80%"}).text(function(a){return drawCompositeLine("compositeRemainderValue",a)})}}}function redrawCompositeNumbers(){d3.selectAll(".compositeCountT").remove(),d3.selectAll(".compositeCountR").remove(),drawCompositeNumbers()}function fnShowText(){showText=!showText,document.getElementById("chkShowText").checked=showText,draw()}function fnLineSpacing(){fLineSpacing=!fLineSpacing,draw()}function fnFreeVerseSupport(){fFreeVerse=!fFreeVerse,fFreeVerse?(document.getElementById("chkGhazal").disabled=!0,document.getElementById("spanFreeVerse").style.display="inline",initializeCompositeLines()):(document.getElementById("chkGhazal").disabled=!1,document.getElementById("spanFreeVerse").style.display="none"),draw()}function fnGhazal(){fGhazal=!fGhazal,fGhazal?(document.getElementById("chkFreeVerse").disabled=!0,calculateRadeef(),calculateKaafiyaa()):document.getElementById("chkFreeVerse").disabled=!1,draw()}function fnBaseCountChange(){var a=parseInt(document.getElementById("baseCount").value);a>0?a!=prevBaseCount&&(prevBaseCount=a,fFreeVerse&&redrawCompositeNumbers()):document.getElementById("baseCount").value=prevBaseCount}var charW=24,charH=24,paddingLeft=10,lineSpacing=7,mode="analyze",showText=!0,prevText="",prevBaseCount=1,fLineSpacing=!0,fFreeVerse=!1,selWord=1,chars=[],maxLen=0,maxLineLen=0,compositeLinesMarkingA=[],fGhazal=!1,radeef="",radeefArray=[],radeefTruncated=0;