class cChar{constructor(e,a){this.mainChar=e,this.mainCharCode=a,this.vowelChar="",this.vowelNumber=0,this.index=0,this.maatraa=0,this.maatraaCumulative=0,this.isRadeef=!1,this.isKaafiyaa=!1,(32==a||44==a||a>=2309&&a<=2324)&&(this.vowel=e),(a>=2325&&a<=2361||a>=2392&&a<=2399)&&(this.vowel="अ"),2306==a&&(this.vowel="्")}set vowel(e){switch(this.vowelChar=e,e){case"्":this.vowelNumber=-1;break;case"अ":this.vowelNumber=1;break;case"आ":case"ा":this.vowelNumber=2;break;case"इ":case"ि":this.vowelNumber=3;break;case"ई":case"ी":this.vowelNumber=4;break;case"उ":case"ु":this.vowelNumber=5;break;case"ऊ":case"ू":this.vowelNumber=6;break;case"ए":case"े":this.vowelNumber=7;break;case"ऐ":case"ै":this.vowelNumber=8;break;case"ओ":case"ो":this.vowelNumber=9;break;case"औ":case"ौ":this.vowelNumber=10;break;case"ऑ":case"ॉ":this.vowelNumber=11;break;case"ऋ":case"ृ":this.vowelNumber=12;break;default:this.vowelNumber=-10}switch(this.vowelNumber){case 1:case 3:case 5:case 12:this.maatraa=1;break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:case 11:this.maatraa=2;break;default:this.maatraa=0}}isHalfLetter(){return-1==this.vowelNumber}isPureVowel(){return this.mainChar==this.vowelChar}isLaghu(){switch(this.vowelNumber){case 1:case 3:case 5:case 12:return!0;default:return!1}}isDeergha(){switch(this.vowelNumber){case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:return!0;default:return!1}}calculateHalfLetterLen(e=!1,a=!1){return e?-10===e.vowelNumber?(this.maatraa=0,this.maatraa):"म"==this.mainChar&&"ह"==a.mainChar?(this.maatraa=0,this.maatraa):"न"==this.mainChar&&"ह"==a.mainChar?(this.maatraa=0,this.maatraa):e.isLaghu()?(this.maatraa=1,this.maatraa):a&&e.isDeergha()&&a.isDeergha()?(this.maatraa=1,this.maatraa):0:(this.maatraa=0,this.maatraa)}adjustCharMaatraa(){(this.vowelNumber%2==0||this.vowelNumber>6&&this.vowelNumber<12)&&(1==this.maatraa?this.maatraa=2:this.maatraa=1),-1==this.vowelNumber&&(0==this.maatraa?this.maatraa=1:this.maatraa=0)}get text(){let e="";return-10!=this.vowelNumber&&0!=this.vowelNumber&&(e=this.isPureVowel()||1==this.vowelNumber?this.mainChar:this.mainChar+this.vowelChar),e}get joinedConsonantVowel(){return this.mainChar==this.vowelChar?this.vowelChar:"अ"==this.vowelChar?this.mainChar:this.mainChar+this.vowelChar}}class cLine{constructor(){this.characters=new Array,this.count=0,this.maatraa=0,this.isComposite=!1}lastCharVowel(e){const a=this.characters[this.count-1],t=a.maatraa;a.vowel=e,this.maatraa+=a.maatraa-t,a.maatraaCumulative+=a.maatraa-t}push(e){e.index=this.count,0==e.index?e.maatraaCumulative=e.maatraa:e.maatraaCumulative=this.characters[this.count-1].maatraaCumulative+e.maatraa,this.characters.push(e),this.maatraa+=e.maatraa,this.count++}charByIndex(e){return this.characters[e]}previousChar(e){return 0!=e.index&&this.count>1&&this.characters[e.index-1]}nextChar(e){return this.count>1&&e.index<this.count-1&&this.characters[e.index+1]}getHalfLetters(){return this.characters.filter(function(e){return e.isHalfLetter()})}calculateHalfLettersMaatraa(){const e=this.getHalfLetters();let a,t=0;for(a=0;a<e.length;a++){const r=e[a];if(t=0,0==r.index)t=r.calculateHalfLetterLen();else{const e=this.previousChar(r),a=this.nextChar(r);t=r.calculateHalfLetterLen(e,a)}if(t>0){let e;for(this.maatraa+=t,r.maatraaCumulative+=t,e=r.index+1;e<this.count;e++)this.characters[e].maatraaCumulative++}}}adjustCharMaatraa(e){let a=this.charByIndex(e),t=a.maatraa;a.adjustCharMaatraa();let r,s=a.maatraa-t;for(this.maatraa+=s,r=e;r<this.count;r++)this.charByIndex(r).maatraaCumulative+=s;return this.maatraa}}class compositeLine{constructor(e){this.originalLineIdx=e,this.maatraa=0,this.remainder=0}}class cPoem{constructor(e){this.originalText=e,this.lines=new Array,this.lineCount=0,this.maxLineLen=0,this.compositeLines=[],this.baseCount=1,this.radeefTruncated=0,this.radeefArray=[]}pushLine(e){this.lines.push(e),this.lineCount++,this.maxLineLen<e.maatraa&&(this.maxLineLen=e.maatraa)}get text(){return this.originalText}adjustCharMaatraa(e,a){let t=this.lines[e].adjustCharMaatraa(a);this.maxLineLen<t&&(this.maxLineLen=t)}setComposite(e){this.lines[e].isComposite=!this.lines[e].isComposite,this.calculateCompositeMaatraa()}setBaseCount(e){this.baseCount=e,this.calculateCompositeMaatraa()}calculateCompositeMaatraa(){let e,a=!1;if(this.compositeLines.length=0,this.lineCount>1){let e=0;for(e=1;e<this.lines.length;e++)if(this.lines[e].isComposite){let t=this.compositeLines.length;a?this.compositeLines[t-1].maatraa+=this.lines[e].maatraa:(a=!0,this.compositeLines[t]=new compositeLine(e-1),this.compositeLines[t].maatraa=this.lines[e-1].maatraa,this.compositeLines[t].maatraa+=this.lines[e].maatraa),t=this.compositeLines.length,this.compositeLines[t-1].maatraa%this.baseCount==0?this.compositeLines[t-1].multipleOfBaseCount=!0:this.compositeLines[t-1].multipleOfBaseCount=!1}else a&&(a=!1)}for(e=0;e<this.compositeLines.length;e++)this.calculateRemainder(e)}calculateRemainder(e){if(this.baseCount>1){let a=this.compositeLines[e].maatraa,t=a%this.baseCount;if(0!=t){let r=a/this.baseCount,s=parseInt(r),i=r-s;this.compositeLines[e].remainder=i<=.5?t:-1*((s+1)*this.baseCount-a)}}else this.compositeLines[e].remainder=0}calculateRadeef(){let e,a,t="";this.radeefArray=[];let r=!1,s=this.lines[0].count-1,i=this.lines[1].count-1;for(;!r&&s>=0&&i>=0;)(e=this.lines[0].characters[s].joinedConsonantVowel)==(a=this.lines[1].characters[i].joinedConsonantVowel)?(t=e+t,this.radeefArray[this.radeefArray.length]=[],this.radeefArray[this.radeefArray.length-1][0]=this.lines[0].characters[s].mainChar,this.radeefArray[this.radeefArray.length-1][1]=this.lines[0].characters[s].vowelChar,s--,i--):r=!0;let n=t.substr(t.indexOf(" ")+1);if(t!==n){for(this.radeefTruncated=1,s=this.radeefArray.length-1;s>=0&&" "!=this.radeefArray[s][0];s--);this.radeefArray.length=s,t=n}let o=this.radeefArray.length;for(s=0;s<this.lines.length;s++){let e=!1;s<=1&&(e=!0),s>1&&s<this.lines.length-1&&0==this.lines[s+1].characters.length&&(e=!0),s==this.lines.length-1&&(e=!0);let a=this.lines[s].characters.length;if(e&&a>o)for(let e=0;e<o&&(this.radeefArray[e][0]==this.lines[s].characters[a-1-e].mainChar&&this.radeefArray[e][1]==this.lines[s].characters[a-1-e].vowelChar);e++)this.lines[s].characters[a-1-e].isRadeef=!0}}calculateKaafiyaa(){let e,a,t,r=this.radeefArray.length,s=!1,i=[],n=this.lines[0].characters.length-1-r,o=this.lines[1].characters.length-1-r;for(;!s&&n>=0&&o>=0;)(a=this.lines[0].characters[n].vowelNumber)==(t=this.lines[1].characters[o].vowelNumber)?(e=a+e,i[i.length]=a,n--,o--):s=!0;-10==i[0]&&i.splice(0,1);let h=i.length;for(n=0;n<this.lines.length;n++){let e=!1;n<=1&&(e=!0),n>1&&n<this.lines.length-1&&0==this.lines[n+1].characters.length&&(e=!0),n==this.lines.length-1&&(e=!0);let a=this.lines[n].characters.length;if(e&&a>r+h+this.radeefTruncated)for(o=0;o<h&&i[o]==this.lines[n].characters[a-1-r-this.radeefTruncated-o].vowelNumber;o++)this.lines[n].characters[a-1-r-this.radeefTruncated-o].isKaafiyaa=!0}}}var oPoem,oPrevPoem;function visualize(){if(splitNprocessPoem(),fGhazal&&(oPoem.calculateRadeef(),oPoem.calculateKaafiyaa()),fFreeVerse){let e=parseInt(document.getElementById("baseCount").value);oPoem.setBaseCount(e)}draw(),document.getElementById("divControls").style.display="block"}function splitNprocessPoem(){oPrevPoem=oPoem;const e=(oPoem=new cPoem(document.getElementById("pom").value)).text.split("\n");let a=[];void 0!==oPrevPoem&&(a=oPrevPoem.originalText.split("\n"));const t=e.length;let r;for(r=0;r<t;r++)if(r<a.length&&e[r]==a[r])oPoem.pushLine(oPrevPoem.lines[r]);else{const a=new cLine;for(e[r]=e[r].replace(/[^\u0900-\u097F ]/g," "),e[r]=e[r].replace("।"," "),e[r]=e[r].replace(/\s+/g," "),e[r]=e[r].trim(),k=0;k<e[r].length;k++)if(charCode=e[r].charCodeAt(k),charCode>=2366&&charCode<=2381)a.lastCharVowel(e[r].substring(k,k+1));else{var s=e[r].substring(k,k+1);const t=new cChar(s,charCode);a.push(t)}a.calculateHalfLettersMaatraa(),oPoem.pushLine(a)}}var charW=20,charH=20,paddingLeft=10,lineSpacing=5,fShowText=!0,fLineSpacing=!0,fFreeVerse=!1,fGhazal=!1;function draw(){const e=oPoem.maxLineLen,a=oPoem.lineCount;var t=d3.select("#chart");t.select("svg").remove();var r=t.append("svg").attr("width",function(){return fFreeVerse?charW*e+120:charW*e+100}).attr("height",function(){return fLineSpacing?a*(charH+lineSpacing)+2*charH:a*charH+2*charH}).attr("style","border-bottom: solid 1px #ddd;");if(fLineSpacing)var s=r.selectAll("g").data(oPoem.lines).enter().append("svg:g").attr("transform",function(e,a){return"translate("+paddingLeft+","+(a*(charH+lineSpacing)+(charH+lineSpacing))+")"}).attr("id",function(e,a){return"gLine"+a});else s=r.selectAll("g").data(oPoem.lines).enter().append("svg:g").attr("transform",function(e,a){return"translate("+paddingLeft+","+(a*charH+charH)+")"}).attr("id",function(e,a){return"gLine"+a});fShowText&&s.selectAll("text").data(function(e){return e.characters}).enter().append("svg:text").attr("y",charH-2).attr("x",function(e){return drawCharTxtPos(e)}).attr("class","graphText3").attr("text-anchor","middle").text(function(e){return e.text}),s.selectAll("path").data(function(e){return e.characters}).enter().append("path").attr("id",function(e,a){return"char"+a}).attr("style",function(e,a){return drawStyleCharBlock(e,fGhazal?"ghazal":"consonant")}).attr("d",function(e,a){return drawVowPath(e,a)}).attr("title",function(e,a){return e.mainChar+e.vowelChar}).on("click",adjustCharLen),fFreeVerse?(s.append("svg:text").attr("y",charH).attr("x",function(a){return charW*e+charW}).attr("class","graphText3").text(function(e){return e.maatraa>0?e.maatraa:""}).on("click",markCompositeLine),s.append("svg:line").attr("x1",function(a,t){return charW*e+2*charW}).attr("y1",function(e,a){return charH+2}).attr("x2",function(a){return charW*e+2.3*charW}).attr("y2",charH+2).attr("style",function(e,a){return drawFreeVerseDashStyle(a)}).on("click",markCompositeLine),s.append("svg:line").attr("x1",function(e,a){return drawCompositeLineMarker("x1",a)}).attr("y1",function(e,a){return drawCompositeLineMarker("y1",a)}).attr("x2",function(a){return charW*e+2.3*charW}).attr("y2",charH+2).attr("style",function(e,a){return drawCompositeLineMarker("style",a)}).on("click",unmarkCompositeLine)):s.append("svg:text").attr("y",charH).attr("x",function(a){return charW*e+charW/2}).attr("class","graphText3").text(function(e){return e.maatraa>0?e.maatraa:""}),fFreeVerse&&drawCompositeNumbers()}function drawCharTxtPos(e){return(e.maatraaCumulative-e.maatraa)*charW+charW*e.maatraa/2}function drawStyleCharBlock(e,a){if(-10===e.vowelNumber)return"display: none";var t="white",r="0.2";return"consonant"==a&&(t="rgb(0,220,255)"),"ghazal"==a&&(e.isRadeef&&(t="rgb(0,220,255)",r="0.5"),e.isKaafiyaa&&(t="rgb(0,255,0)",r="0.5")),-1==e.vowelNumber&&0==e.maatraa&&(t="black",r="0.6"),"fill: "+t+"; fill-opacity: "+r+";stroke:black; stroke-width: 1; stroke-opacity: 0.3"}function drawVowPath(e,a){var t=(e.maatraaCumulative-e.maatraa)*charW,r=charW*e.maatraa,s=charH;return-1==e.vowelNumber&&0==e.maatraa?"M"+(t-=2)+",0 L"+t+",-"+(s=4)+" L"+(t+(r=4))+",-"+s+" L"+(t+r)+",0 z":"M"+t+",0 L"+t+","+s+" L"+(t+r)+","+s+" L"+(t+r)+",0 z"}function fnShowText(){fShowText=!fShowText,document.getElementById("chkShowText").checked=fShowText,draw()}function drawFreeVerseDashStyle(e){return 0==oPoem.lines[e].maatraa?"display:none;":"stroke:black;stroke-width:4;"}function fnFreeVerseSupport(){if(fFreeVerse=!fFreeVerse){document.getElementById("chkGhazal").disabled=!0,document.getElementById("spanFreeVerse").style.display="inline";let e=parseInt(document.getElementById("baseCount").value);oPoem.setBaseCount(e)}else document.getElementById("chkGhazal").disabled=!1,document.getElementById("spanFreeVerse").style.display="none";draw()}function drawCompositeLineMarker(e,a){const t=oPoem.maxLineLen;return"x1"==e?0==a?charW*t+2*charW:oPoem.lines[a].isComposite?charW*t+2.3*charW:charW*t+2*charW:"y1"==e?oPoem.lines[a].isComposite?fLineSpacing?-3:0:charH:"style"==e?0!=oPoem.lines[a].maatraa&&oPoem.lines[a].isComposite?"stroke:black;stroke-width:4;":"display:none;":void 0}function drawCompositeNumbers(){const e=oPoem.maxLineLen;let a=d3.select("#chart").select("svg"),t=0;t=fLineSpacing?charH+lineSpacing:charH;a.selectAll(".compositeCountT").data(oPoem.compositeLines).enter().append("svg:text").attr("y",function(e){return e.originalLineIdx*t+t+charH}).attr("x",function(a){return paddingLeft+8+charW*e+2*charW}).attr("class","compositeCountT").attr("style",function(e){return e.multipleOfBaseCount?"fill:black":"fill:red"}).text(function(e){return e.maatraa}),a.selectAll(".compositeCountR").data(oPoem.compositeLines).enter().append("svg:text").attr("y",function(e){return e.originalLineIdx*t+t+charH+10}).attr("x",function(a){return paddingLeft+8+charW*e+2*charW+20}).attr("class","compositeCountR").attr("style",function(e){return 0!=e.remainder?"fill:red;font-size:80%":"display:none"}).text(function(e){return e.remainder>0?"+"+e.remainder:e.remainder})}function fnLineSpacing(){fLineSpacing=!fLineSpacing,draw()}function adjustCharLen(){var e=parseInt(this.getAttribute("id").substring(4)),a=parseInt(this.parentNode.getAttribute("id").substring(5));oPoem.adjustCharMaatraa(a,e),draw()}function markCompositeLine(){let e=parseInt(this.parentNode.getAttribute("id").substring(5));e<oPoem.lines.length-1&&!oPoem.lines[e+1].isComposite&&(oPoem.setComposite(e+1),draw())}function unmarkCompositeLine(){var e=parseInt(this.parentNode.getAttribute("id").substring(5));e>0&&(oPoem.setComposite(e),draw())}function fnBaseCountChange(){let e=parseInt(document.getElementById("baseCount").value);e>0?e!=oPoem.baseCount&&(oPoem.setBaseCount(e),draw()):document.getElementById("baseCount").value=prevBaseCount}function fnGhazal(){(fGhazal=!fGhazal)?(document.getElementById("chkFreeVerse").disabled=!0,oPoem.calculateRadeef(),oPoem.calculateKaafiyaa()):document.getElementById("chkFreeVerse").disabled=!1,draw()}