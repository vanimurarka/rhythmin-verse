class cChar{constructor(a,e){this.mainChar=a,this.mainCharCode=e,this.vowelChar="",this.vowelNumber=0,this.index=0,this.maatraa=0,this.systemMaatraa=0,this.maatraaCumulative=0,this.isRadeef=!1,this.isKaafiyaa=!1,(32==e||44==e||e>=2309&&e<=2324)&&(this.vowel=a),(e>=2325&&e<=2361||e>=2392&&e<=2399)&&(this.vowel="अ"),2306==e&&(this.vowel="्")}set vowel(a){switch(this.vowelChar=a,a){case"्":this.vowelNumber=-1;break;case"अ":this.vowelNumber=1;break;case"आ":case"ा":this.vowelNumber=2;break;case"इ":case"ि":this.vowelNumber=3;break;case"ई":case"ी":this.vowelNumber=4;break;case"उ":case"ु":this.vowelNumber=5;break;case"ऊ":case"ू":this.vowelNumber=6;break;case"ए":case"े":this.vowelNumber=7;break;case"ऐ":case"ै":this.vowelNumber=8;break;case"ओ":case"ो":this.vowelNumber=9;break;case"औ":case"ौ":this.vowelNumber=10;break;case"ऑ":case"ॉ":this.vowelNumber=11;break;case"ऋ":case"ृ":this.vowelNumber=12;break;default:this.vowelNumber=-10}switch(this.vowelNumber){case 1:case 3:case 5:case 12:this.maatraa=1,this.systemMaatraa=1;break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:case 11:this.maatraa=2,this.systemMaatraa=2;break;default:this.maatraa=0,this.systemMaatraa=0}}isHalfLetter(){return-1==this.vowelNumber}isPureVowel(){return this.mainChar==this.vowelChar}isLaghu(){switch(this.vowelNumber){case 1:case 3:case 5:case 12:return!0;default:return!1}}isDeergha(){switch(this.vowelNumber){case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:return!0;default:return!1}}calculateHalfLetterLen(a=!1,e=!1){return a?-10===a.vowelNumber?(this.maatraa=0,this.systemMaatraa=0,this.maatraa):"म"==this.mainChar&&"ह"==e.mainChar?(this.maatraa=0,this.systemMaatraa=0,this.maatraa):"न"==this.mainChar&&"ह"==e.mainChar?(this.maatraa=0,this.systemMaatraa=0,this.maatraa):a.isLaghu()?(this.maatraa=1,this.systemMaatraa=1,this.maatraa):e&&a.isDeergha()&&e.isDeergha()?(this.maatraa=1,this.systemMaatraa=1,this.maatraa):0:(this.maatraa=0,this.systemMaatraa=0,this.maatraa)}adjustCharMaatraa(){(this.vowelNumber%2==0||this.vowelNumber>6&&this.vowelNumber<12)&&(1==this.maatraa?this.maatraa=2:this.maatraa=1),-1==this.vowelNumber&&(0==this.maatraa?this.maatraa=1:this.maatraa=0)}get text(){let a="";return-10!=this.vowelNumber&&0!=this.vowelNumber&&(a=this.isPureVowel()||1==this.vowelNumber?this.mainChar:this.mainChar+this.vowelChar),a}get joinedConsonantVowel(){return this.mainChar==this.vowelChar?this.vowelChar:"अ"==this.vowelChar?this.mainChar:this.mainChar+this.vowelChar}}class cLine{constructor(){this.characters=new Array,this.count=0,this.maatraa=0,this.isComposite=!1}lastCharVowel(a){const e=this.characters[this.count-1],t=e.maatraa;e.vowel=a,this.maatraa+=e.maatraa-t,e.maatraaCumulative+=e.maatraa-t}push(a){a.index=this.count,0==a.index?a.maatraaCumulative=a.maatraa:a.maatraaCumulative=this.characters[this.count-1].maatraaCumulative+a.maatraa,this.characters.push(a),this.maatraa+=a.maatraa,this.count++}charByIndex(a){return this.characters[a]}previousChar(a){return 0!=a.index&&this.count>1&&this.characters[a.index-1]}nextChar(a){return this.count>1&&a.index<this.count-1&&this.characters[a.index+1]}getHalfLetters(){return this.characters.filter(function(a){return a.isHalfLetter()})}calculateHalfLettersMaatraa(){const a=this.getHalfLetters();let e,t=0;for(e=0;e<a.length;e++){const r=a[e];if(t=0,0==r.index)t=r.calculateHalfLetterLen();else{const a=this.previousChar(r),e=this.nextChar(r);t=r.calculateHalfLetterLen(a,e)}if(t>0){let a;for(this.maatraa+=t,r.maatraaCumulative+=t,a=r.index+1;a<this.count;a++)this.characters[a].maatraaCumulative++}}}adjustCharMaatraa(a){let e=this.charByIndex(a),t=e.maatraa;e.adjustCharMaatraa();let r,s=e.maatraa-t;for(this.maatraa+=s,r=a;r<this.count;r++)this.charByIndex(r).maatraaCumulative+=s;return this.maatraa}}class compositeLine{constructor(a){this.originalLineIdx=a,this.maatraa=0,this.remainder=0}}class cPoem{constructor(a){this.originalText=a,this.lines=new Array,this.lineCount=0,this.maxLineLen=0,this.compositeLines=[],this.baseCount=1,this.radeefTruncated=0,this.radeefArray=[]}pushLine(a){this.lines.push(a),this.lineCount++,this.maxLineLen<a.maatraa&&(this.maxLineLen=a.maatraa)}get text(){return this.originalText}adjustCharMaatraa(a,e){let t=this.lines[a].adjustCharMaatraa(e);this.maxLineLen<t&&(this.maxLineLen=t)}setComposite(a){this.lines[a].isComposite=!this.lines[a].isComposite,this.calculateCompositeMaatraa()}setBaseCount(a){this.baseCount=a,this.calculateCompositeMaatraa()}calculateCompositeMaatraa(){let a,e=!1;if(this.compositeLines.length=0,this.lineCount>1){let a=0;for(a=1;a<this.lines.length;a++)if(this.lines[a].isComposite){let t=this.compositeLines.length;e?this.compositeLines[t-1].maatraa+=this.lines[a].maatraa:(e=!0,this.compositeLines[t]=new compositeLine(a-1),this.compositeLines[t].maatraa=this.lines[a-1].maatraa,this.compositeLines[t].maatraa+=this.lines[a].maatraa),t=this.compositeLines.length,this.compositeLines[t-1].maatraa%this.baseCount==0?this.compositeLines[t-1].multipleOfBaseCount=!0:this.compositeLines[t-1].multipleOfBaseCount=!1}else e&&(e=!1)}for(a=0;a<this.compositeLines.length;a++)this.calculateRemainder(a)}calculateRemainder(a){if(this.baseCount>1){let e=this.compositeLines[a].maatraa,t=e%this.baseCount;if(0!=t){let r=e/this.baseCount,s=parseInt(r),i=r-s;this.compositeLines[a].remainder=i<=.5?t:-1*((s+1)*this.baseCount-e)}}else this.compositeLines[a].remainder=0}calculateRadeef(){let a,e,t="";this.radeefArray=[];let r=!1,s=this.lines[0].count-1,i=this.lines[1].count-1;for(;!r&&s>=0&&i>=0;)(a=this.lines[0].characters[s].joinedConsonantVowel)==(e=this.lines[1].characters[i].joinedConsonantVowel)?(t=a+t,this.radeefArray[this.radeefArray.length]=[],this.radeefArray[this.radeefArray.length-1][0]=this.lines[0].characters[s].mainChar,this.radeefArray[this.radeefArray.length-1][1]=this.lines[0].characters[s].vowelChar,s--,i--):r=!0;let n=t.substr(t.indexOf(" ")+1);if(t!==n){for(this.radeefTruncated=1,s=this.radeefArray.length-1;s>=0&&" "!=this.radeefArray[s][0];s--);this.radeefArray.length=s,t=n}let o=this.radeefArray.length;for(s=0;s<this.lines.length;s++){let a=!1;s<=1&&(a=!0),s>1&&s<this.lines.length-1&&0==this.lines[s+1].characters.length&&(a=!0),s==this.lines.length-1&&(a=!0);let e=this.lines[s].characters.length;if(a&&e>o)for(let a=0;a<o&&(this.radeefArray[a][0]==this.lines[s].characters[e-1-a].mainChar&&this.radeefArray[a][1]==this.lines[s].characters[e-1-a].vowelChar);a++)this.lines[s].characters[e-1-a].isRadeef=!0}}calculateKaafiyaa(){let a,e,t,r=this.radeefArray.length,s=!1,i=[],n=this.lines[0].characters.length-1-r,o=this.lines[1].characters.length-1-r;for(;!s&&n>=0&&o>=0;)(e=this.lines[0].characters[n].vowelNumber)==(t=this.lines[1].characters[o].vowelNumber)?(a=e+a,i[i.length]=e,n--,o--):s=!0;-10==i[0]&&i.splice(0,1);let h=i.length;for(n=0;n<this.lines.length;n++){let a=!1;n<=1&&(a=!0),n>1&&n<this.lines.length-1&&0==this.lines[n+1].characters.length&&(a=!0),n==this.lines.length-1&&(a=!0);let e=this.lines[n].characters.length;if(a&&e>r+h+this.radeefTruncated)for(o=0;o<h&&i[o]==this.lines[n].characters[e-1-r-this.radeefTruncated-o].vowelNumber;o++)this.lines[n].characters[e-1-r-this.radeefTruncated-o].isKaafiyaa=!0}}}class cVisual{constructor(a){this.availableW=a,this.mode="fixed",this.width=0,this.ratio=1}}var oPoem,oPrevPoem,oVisual;function visualize(a,e){if(splitNprocessPoem(a),fGhazal&&(oPoem.calculateRadeef(),oPoem.calculateKaafiyaa()),fFreeVerse){let a=parseInt(document.getElementById("baseCount").value);oPoem.setBaseCount(a)}oVisual=new cVisual(e),draw(),document.getElementById("divControls").style.display="block"}function redraw(a){oVisual=new cVisual(a),draw()}function splitNprocessPoem(a){oPrevPoem=oPoem;const e=(oPoem=new cPoem(a)).text.split("\n");let t=[];void 0!==oPrevPoem&&(t=oPrevPoem.originalText.split("\n"));const r=e.length;let s;for(s=0;s<r;s++)if(s<t.length&&e[s]==t[s])oPoem.pushLine(oPrevPoem.lines[s]);else{const a=new cLine;for(e[s]=e[s].replace(/[^\u0900-\u097F ]/g," "),e[s]=e[s].replace("।"," "),e[s]=e[s].replace(/\s+/g," "),e[s]=e[s].trim(),k=0;k<e[s].length;k++)if(charCode=e[s].charCodeAt(k),charCode>=2366&&charCode<=2381)a.lastCharVowel(e[s].substring(k,k+1));else{var i=e[s].substring(k,k+1);const t=new cChar(i,charCode);a.push(t)}a.calculateHalfLettersMaatraa(),oPoem.pushLine(a)}}var charW=20,charH=20,paddingLeft=10,lineSpacing=5,fShowText=!0,fLineSpacing=!0,fFreeVerse=!1,fGhazal=!1;function draw(){const a=oPoem.maxLineLen,e=oPoem.lineCount;var t=d3.select("#chart");t.select("svg").remove();const r=fFreeVerse?charW*a+120:charW*a+100,s=fLineSpacing?e*(charH+lineSpacing)+2*charH:e*charH+2*charH,i="0 0 "+r+" "+s,n=oVisual.availableW/r;var o;if(oVisual.availableW<=500?(oVisual.mode="flexible",oVisual.width=r,oVisual.ratio=n,o=t.append("svg").attr("viewBox",i).attr("preserveAspectRatio","xMidYMid meet").attr("style","border-bottom: solid 1px #ddd;")):n>=.6&&n<=1?(oVisual.mode="flexible",oVisual.width=r,oVisual.ratio=n,o=t.append("svg").attr("viewBox",i).attr("preserveAspectRatio","xMidYMid meet").attr("style","border-bottom: solid 1px #ddd;")):(oVisual.mode="fixed",oVisual.width=r,oVisual.ratio=n,o=t.append("svg").attr("width",function(){return r}).attr("height",function(){return s}).attr("style","border-bottom: solid 1px #ddd;")),fLineSpacing)var h=o.selectAll("g").data(oPoem.lines).enter().append("svg:g").attr("transform",function(a,e){return"translate("+paddingLeft+","+(e*(charH+lineSpacing)+(charH+lineSpacing))+")"}).attr("id",function(a,e){return"gLine"+e});else h=o.selectAll("g").data(oPoem.lines).enter().append("svg:g").attr("transform",function(a,e){return"translate("+paddingLeft+","+(e*charH+charH)+")"}).attr("id",function(a,e){return"gLine"+e});fShowText&&h.selectAll("text").data(function(a){return a.characters}).enter().append("svg:text").attr("y",charH-2).attr("x",function(a){return drawCharTxtPos(a)}).attr("class","graphText3").attr("text-anchor","middle").text(function(a){return a.text}),h.selectAll("path").data(function(a){return a.characters}).enter().append("path").attr("id",function(a,e){return"char"+e}).attr("style",function(a,e){return drawStyleCharBlock(a,fGhazal?"ghazal":"consonant")}).attr("d",function(a,e){return drawVowPath(a,e)}).attr("title",function(a,e){return a.mainChar+a.vowelChar}).on("click",adjustCharLen),fFreeVerse?(h.append("svg:text").attr("y",charH).attr("x",function(e){return charW*a+charW}).attr("class","graphText3").text(function(a){return a.maatraa>0?a.maatraa:""}).on("click",markCompositeLine),h.append("svg:line").attr("x1",function(e,t){return charW*a+2*charW}).attr("y1",function(a,e){return charH-2}).attr("x2",function(e){return charW*a+2.3*charW}).attr("y2",charH-2).attr("style",function(a,e){return drawFreeVerseDashStyle(e)}).on("click",markCompositeLine),h.append("svg:line").attr("x1",function(a,e){return drawCompositeLineMarker("x1",e)}).attr("y1",function(a,e){return drawCompositeLineMarker("y1",e)}).attr("x2",function(e){return charW*a+2.45*charW}).attr("y2",charH+2).attr("style",function(a,e){return drawCompositeLineMarker("style",e)}).on("click",unmarkCompositeLine)):h.append("svg:text").attr("y",charH).attr("x",function(e){return charW*a+charW/2}).attr("class","graphText3").text(function(a){return a.maatraa>0?a.maatraa:""}),fFreeVerse&&drawCompositeNumbers()}function drawCharTxtPos(a){return(a.maatraaCumulative-a.maatraa)*charW+charW*a.maatraa/2}function drawStyleCharBlock(a,e){if(-10===a.vowelNumber)return"display: none";var t="white",r="0.2";return"consonant"==e&&(a.maatraa==a.systemMaatraa?t="rgb(0,220,255)":(t="yellow",r="0.5")),"ghazal"==e&&(a.isRadeef&&(t="rgb(0,220,255)",r="0.5"),a.isKaafiyaa&&(t="rgb(0,255,0)",r="0.5")),-1==a.vowelNumber&&0==a.maatraa&&(t="black",r="0.6",a.maatraa!==a.systemMaatraa&&(t="yellow",r="1")),"fill: "+t+"; fill-opacity: "+r+";stroke:black; stroke-width: 1; stroke-opacity: 0.3"}function drawVowPath(a,e){var t=(a.maatraaCumulative-a.maatraa)*charW,r=charW*a.maatraa,s=charH;return-1==a.vowelNumber&&0==a.maatraa?"M"+(t-=2)+",0 L"+t+",-"+(s=4)+" L"+(t+(r=4))+",-"+s+" L"+(t+r)+",0 z":"M"+t+",0 L"+t+","+s+" L"+(t+r)+","+s+" L"+(t+r)+",0 z"}function fnShowText(){fShowText=!fShowText,document.getElementById("chkShowText").checked=fShowText,draw()}function drawFreeVerseDashStyle(a){return 0==oPoem.lines[a].maatraa?"display:none;":"stroke:black;stroke-width:8;"}function fnFreeVerseSupport(){if(fFreeVerse=!fFreeVerse){document.getElementById("chkGhazal").disabled=!0,document.getElementById("spanFreeVerse").style.display="inline";let a=parseInt(document.getElementById("baseCount").value);oPoem.setBaseCount(a)}else document.getElementById("chkGhazal").disabled=!1,document.getElementById("spanFreeVerse").style.display="none";draw()}function drawCompositeLineMarker(a,e){const t=oPoem.maxLineLen;return"x1"==a?0==e?charW*t+2*charW:oPoem.lines[e].isComposite?charW*t+2.45*charW:charW*t+2*charW:"y1"==a?oPoem.lines[e].isComposite?fLineSpacing?-11:0:charH-2:"style"==a?0!=oPoem.lines[e].maatraa&&oPoem.lines[e].isComposite?"stroke:green;stroke-width:6;":"display:none;":void 0}function drawCompositeNumbers(){const a=oPoem.maxLineLen;let e=d3.select("#chart").select("svg"),t=0;t=fLineSpacing?charH+lineSpacing:charH;e.selectAll(".compositeCountT").data(oPoem.compositeLines).enter().append("svg:text").attr("y",function(a){return a.originalLineIdx*t+t+charH}).attr("x",function(e){return paddingLeft+12+charW*a+2*charW}).attr("class","compositeCountT").attr("style",function(a){return a.multipleOfBaseCount?"fill:black":"fill:red"}).text(function(a){return a.maatraa}),e.selectAll(".compositeCountR").data(oPoem.compositeLines).enter().append("svg:text").attr("y",function(a){return a.originalLineIdx*t+t+charH+10}).attr("x",function(e){return paddingLeft+8+charW*a+2*charW+20}).attr("class","compositeCountR").attr("style",function(a){return 0!=a.remainder?"fill:red;font-size:80%":"display:none"}).text(function(a){return a.remainder>0?"+"+a.remainder:a.remainder})}function fnLineSpacing(){fLineSpacing=!fLineSpacing,draw()}function adjustCharLen(){var a=parseInt(this.getAttribute("id").substring(4)),e=parseInt(this.parentNode.getAttribute("id").substring(5));oPoem.adjustCharMaatraa(e,a),draw()}function markCompositeLine(){let a=parseInt(this.parentNode.getAttribute("id").substring(5));a<oPoem.lines.length-1&&!oPoem.lines[a+1].isComposite&&(oPoem.setComposite(a+1),draw())}function unmarkCompositeLine(){var a=parseInt(this.parentNode.getAttribute("id").substring(5));a>0&&(oPoem.setComposite(a),draw())}function fnBaseCountChange(){let a=parseInt(document.getElementById("baseCount").value);a>0?a!=oPoem.baseCount&&(oPoem.setBaseCount(a),draw()):document.getElementById("baseCount").value=prevBaseCount}function fnGhazal(){(fGhazal=!fGhazal)?(document.getElementById("chkFreeVerse").disabled=!0,oPoem.calculateRadeef(),oPoem.calculateKaafiyaa()):document.getElementById("chkFreeVerse").disabled=!1,draw()}