var charW=20,charH=20,paddingLeft=10,lineSpacing=5,mode="analyze",showText=!0,prevText="",prevBaseCount=1,fLineSpacing=!0,fFreeVerse=!1,selWord=1,chars=[],maxLen=0,maxLineLen=0,compositeLinesMarkingA=[],fGhazal=!1,radeef="",radeefArray=[],radeefTruncated=0;function visualize(){splitNprocessPoem(),fFreeVerse&&initializeCompositeLines(),fGhazal&&(calculateRadeef(),calculateKaafiyaa()),draw(),document.getElementById("divControls").style.display="block"}function joinCharConsonantVowel(e,a){return e==a?a:"अ"==a?e:e+a}function calculateRadeef(){var e;radeef="";for(var a=!(radeefArray=[]),r=chars[radeefTruncated=0].length-1,t=chars[1].length-1;!a&&0<=r&&0<=t;)(e=joinCharConsonantVowel(chars[0][r][0],chars[0][r][1]))==joinCharConsonantVowel(chars[1][t][0],chars[1][t][1])?(radeef=e+radeef,radeefArray[radeefArray.length]=[],radeefArray[radeefArray.length-1][0]=chars[0][r][0],radeefArray[radeefArray.length-1][1]=chars[0][r][1],r--,t--):a=!0;var n=radeef.substr(radeef.indexOf(" ")+1);if(radeef!==n){for(console.log("radeef truncated"),radeefTruncated=1,r=radeefArray.length-1;0<=r&&" "!=radeefArray[r][0];r--);radeefArray.length=r,radeef=n}var c=radeefArray.length;for(r=0;r<chars.length;r++){var s=!1;r<=1&&(s=!0),1<r&&r<chars.length-1&&0==chars[r+1].length&&(s=!0),r==chars.length-1&&(s=!0);var i=chars[r].length;if(s&&c<i)for(t=0;t<c&&(radeefArray[t][0]==chars[r][i-1-t][0]&&radeefArray[t][1]==chars[r][i-1-t][1]);t++)chars[r][i-1-t][6]="r"}}function originalVowel(e){switch(e){case" ":case",":return" ";case"अ":return"अ";case"आ":case"ा":return"आ";case"इ":case"ि":return"इ";case"ई":case"ी":return"ई";case"उ":case"ु":return"उ";case"ऊ":case"ू":return"ऊ";case"ए":case"े":return"ए";case"ऐ":case"ै":return"ऐ";case"ओ":case"ो":return"ओ";case"औ":case"ौ":return"औ";case"ृ":return"ृ";default:return-1}return-1}function calculateKaafiyaa(){for(var e,a,r,t=radeefArray.length,n=!1,c=[],s=chars[0].length-1-t,i=chars[1].length-1-t;!n&&0<=s&&0<=i;)a=originalVowel(chars[0][s][1]),r=originalVowel(chars[1][i][1]),console.log(a),console.log(r),a==r?(e=a+e,c[c.length]=a,s--,i--):n=!0;" "==c[0]&&c.splice(0,1),console.log(c);var o=c.length;for(t=radeefArray.length,s=0;s<chars.length;s++){var h=!1;s<=1&&(h=!0),1<s&&s<chars.length-1&&0==chars[s+1].length&&(h=!0),s==chars.length-1&&(h=!0);var l=chars[s].length;if(h&&t+o+radeefTruncated<l)for(i=0;i<o&&c[i]==originalVowel(chars[s][l-1-t-radeefTruncated-i][1]);i++)chars[s][l-1-t-radeefTruncated-i][6]="k"}}function initializeCompositeLines(){for(i=0;i<chars.length;i++)compositeLinesMarkingA[i]=[],0<chars[i].length?compositeLinesMarkingA[i][0]=chars[i][chars[i].length-1][5]:compositeLinesMarkingA[i][0]=0,compositeLinesMarkingA[i][1]=!1}function calculateCompositeLines(){var e=!1,a=[];if(1<chars.length)for(i=1;i<chars.length;i++){var r;if(compositeLinesMarkingA[i][1])if(e)a[(r=a.length)-1][1]+=chars[i][chars[i].length-1][5];else e=!0,a[r=a.length]=[],a[r][0]=i-1,a[r][1]=chars[i-1][chars[i-1].length-1][5],a[r][1]+=chars[i][chars[i].length-1][5];else e=e&&!1}return 0<a.length&&a}function splitNprocessPoem(){var e=document.getElementById("pom").value,a=e.split("\n"),r=prevText.split("\n"),t=0,n=0,c=0,s=0;for(maxLineLen=a.length,t=0;t<maxLineLen;t++)if(t<r.length&&r[t]==a[t])chars[t][chars[t].length]="old";else{for(chars[t]=[],n=0;n<a[t].length;n++)c=a[t].charCodeAt(n),s=chars[t].length,2366<=c&&c<=2381?(chars[t][s-1][1]=a[t].substring(n,n+1),chars[t][s-1][3]=getVowData(chars[t][s-1][1])):((32==c||44==c||2309<=c&&c<=2324)&&(chars[t][s]=["",""],chars[t][s][0]=a[t].substring(n,n+1),chars[t][s][1]=a[t].substring(n,n+1)),(2325<=c&&c<=2361||2392<=c&&c<=2399)&&(chars[t][s]=["",""],chars[t][s][0]=a[t].substring(n,n+1),chars[t][s][1]="अ"),2306==c&&(chars[t][s]=["",""],chars[t][s][0]=a[t].substring(n,n+1),chars[t][s][1]="्"),s=chars[t].length-1,chars[t][s][2]=getConsData(chars[t][s][0]),chars[t][s][3]=getVowData(chars[t][s][1]),chars[t][s][4]=0,chars[t][s][5]=0);chars[t][chars[t].length]="new"}for(t=0;t<chars.length;t++){if("new"==chars[t][chars[t].length-1]){for(n=0;n<chars[t].length-1;n++){switch(chars[t][n][3]){case 1:case 3:case 5:case 11:chars[t][n][4]=1;break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:chars[t][n][4]=2;break;case-1:0==n?n==chars[t].length-2?chars[t][n][4]=halfLetterLen(0,chars[t][n],0):chars[t][n][4]=halfLetterLen(0,chars[t][n],chars[t][n+1]):n==chars[t].length-2?chars[t][n][4]=halfLetterLen(chars[t][n-1],chars[t][n],0):chars[t][n][4]=halfLetterLen(chars[t][n-1],chars[t][n],chars[t][n+1])}chars[t][n][5]=0==n?chars[t][n][4]:chars[t][n-1][5]+chars[t][n][4]}1<chars[t].length&&chars[t][n-1][5]>maxLen&&(maxLen=chars[t][n-1][5])}chars[t].pop()}a.length<chars.length&&(chars.length=a.length),prevText=e}function getVowData(e){switch(e){case" ":case",":return-10;case"अ":return 1;case"आ":case"ा":return 2;case"इ":case"ि":return 3;case"ई":case"ी":return 4;case"उ":case"ु":return 5;case"ऊ":case"ू":return 6;case"ए":case"े":return 7;case"ऐ":case"ै":return 8;case"ओ":case"ो":return 9;case"औ":case"ौ":return 10;case"ृ":return 11;default:return-1}return-1}function getConsData(e){switch(e){case" ":case",":return-10;case"अ":case"आ":case"इ":case"ई":case"उ":case"ऊ":case"ए":case"ऐ":case"ओ":case"औ":return 0;case"क":case"ख":case"ख़":case"ग":case"घ":case"ग़":case"ङ":return 1;case"च":case"छ":case"ज":case"झ":case"ञ":case"ज़":return 2;case"ट":case"ठ":case"ड":case"ढ":case"ण":case"ड़":case"ढ़":return 3;case"त":case"थ":case"द":case"ध":case"न":case"ं":return 4;case"प":case"फ":case"ब":case"भ":case"म":case"फ़":return 5;case"य":case"र":case"ल":case"व":return 6;case"श":case"ष":case"स":case"ह":return 7;default:return-1}return-1}function conColor(e){return["rgb(0,220,255)","0.5"]}function styleCharBlock(e,a){if(-10===e[3])return"display: none";var r="white",t="0.3",n="0.7";if("consonant"==a){var c=conColor(e[2]);r=c[0],n=c[1]}return"ghazal"==a&&6<e.length&&("r"==e[6]&&(r="rgb(0,220,255)",n="1.0"),"k"==e[6]&&(r="rgb(0,255,0)",n="1.0")),-1==e[3]&&0==e[4]&&(r="black",t="1",n="0.7"),"fill: "+r+"; fill-opacity: "+n+";stroke:black; stroke-width: 1; stroke-opacity: "+t}function vowPath(e,a){var r=(e[5]-e[4])*charW,t=charW*e[4];return"M"+r+",0 L"+r+","+charH+" L"+(r+t)+","+charH+" L"+(r+t)+",0 z"}function adjustCharLen(){var e=parseInt(this.getAttribute("id").substring(4)),a=parseInt(this.parentNode.getAttribute("id").substring(5)),r=0;if(chars[a][e][3]%2==0||6<chars[a][e][3]&&chars[a][e][3]<11){if(1==chars[a][e][4]){for(chars[a][e][4]=2,r=e;r<chars[a].length;r++)chars[a][r][5]=chars[a][r][5]+1;return chars[a][r-1][5]>maxLen&&(maxLen=chars[a][r-1][5]),void draw()}if(2==chars[a][e][4]){for(chars[a][e][4]=1,r=e;r<chars[a].length;r++)chars[a][r][5]=chars[a][r][5]-1;return void draw()}}if(-1==chars[a][e][3]){if(0==chars[a][e][4]){for(chars[a][e][4]=1,r=e;r<chars[a].length;r++)chars[a][r][5]=chars[a][r][5]+1;return chars[a][r-1][5]>maxLen&&(maxLen=chars[a][r-1][5]),void draw()}if(1==chars[a][e][4]){for(chars[a][e][4]=0,r=e;r<chars[a].length;r++)chars[a][r][5]=chars[a][r][5]-1;return void draw()}}}function markCompositeLineTextDash(){var e=parseInt(this.parentNode.getAttribute("id").substring(5));e<compositeLinesMarkingA.length-1&&!compositeLinesMarkingA[e+1][1]&&(compositeLinesMarkingA[e+1][1]=!compositeLinesMarkingA[e+1][1],draw())}function unmarkCompositeLine(){var e=parseInt(this.parentNode.getAttribute("id").substring(5));0<e&&(compositeLinesMarkingA[e][1]=!compositeLinesMarkingA[e][1],draw())}function charTxtPos(e,a){return(e[5]-e[4])*charW+charW*e[4]/2}function charTxt(e){var a="";return-10!=e[2]&&(a=0==e[2]||1==e[3]?e[0]:e[0]+e[1]),a}function halfLetterLen(e,a,r){if(0===e)return 0;if(-10===e[2])return 0;if(pLD="",nLD="","म"==a[0]&&"ह"==r[0])return 0;if("न"==a[0]&&"ह"==r[0])return 0;switch(e[3]){case 1:case 3:case 5:case 11:pLD="l";break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:pLD="d"}if("l"===pLD)return 1;switch(r[3]){case 1:case 3:case 5:case 11:nLD="l";break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:nLD="d"}return"d"===pLD&&"d"===nLD?1:0}function drawCompositeLine(e,a){if("x1"==e)return 0==a?charW*maxLen+2*charW:compositeLinesMarkingA[a][1]?charW*maxLen+2.3*charW:charW*maxLen+2*charW;if("y1"==e)return compositeLinesMarkingA[a][1]?fLineSpacing?-3:0:charH;if("styleSmall"==e)return 0==compositeLinesMarkingA[a][0]?"display:none;":"stroke:black;stroke-width:4;";if("styleMain"==e)return 0!=compositeLinesMarkingA[a][0]&&compositeLinesMarkingA[a][1]?"stroke:black;stroke-width:4;":"display:none;";if("styleCompositeLineMaatraa"==e)return 0<(r=parseInt(document.getElementById("baseCount").value))?a[1]%r==0?"fill:black":"fill:red":"fill:black";if("compositeRemainderValue"==e){var r;if(1<(r=parseInt(document.getElementById("baseCount").value))){var t=a[1]%r;if(0!=t){var n=a[1]/r,c=parseInt(n);return n-c<=.5?"+"+t:"-"+((c+1)*r-a[1])}}return""}}function draw(){var e=d3.select("#chart");e.select("svg").remove();var a=e.append("svg").attr("width",function(){return fFreeVerse?charW*maxLen+120:charW*maxLen+100}).attr("height",maxLineLen*(charW+lineSpacing)+charW+charW).attr("style","border-bottom: solid 1px #ddd;");if(fLineSpacing)var r=a.selectAll("g").data(chars).enter().append("svg:g").attr("transform",function(e,a){return"translate("+paddingLeft+","+(a*(charH+lineSpacing)+(charH+lineSpacing))+")"}).attr("id",function(e,a){return"gLine"+a});else r=a.selectAll("g").data(chars).enter().append("svg:g").attr("transform",function(e,a){return"translate("+paddingLeft+","+(a*charH+charH)+")"}).attr("id",function(e,a){return"gLine"+a});r.selectAll("path").data(function(e){return e}).enter().append("path").attr("id",function(e,a){return"char"+a}).attr("style",function(e,a){return styleCharBlock(e,fGhazal?"ghazal":"consonant")}).attr("d",function(e,a){return vowPath(e,a)}).attr("title",function(e,a){return e[0]+e[1]}).on("click",adjustCharLen),showText&&r.selectAll("text").data(function(e){return e}).enter().append("svg:text").attr("y",charH-2).attr("x",function(e,a){return charTxtPos(e)}).attr("class","graphText3").attr("text-anchor","middle").text(function(e){return charTxt(e)}),fFreeVerse?(r.append("svg:text").attr("y",charH).attr("x",function(e){return charW*maxLen+charW}).attr("class","graphText3").text(function(e){return 0<e.length?e[e.length-1][5]:""}).on("click",markCompositeLineTextDash),r.append("svg:line").attr("x1",function(e,a){return charW*maxLen+2*charW}).attr("y1",function(e,a){return charH+2}).attr("x2",function(e){return charW*maxLen+2.3*charW}).attr("y2",charH+2).attr("style",function(e,a){return drawCompositeLine("styleSmall",a)}).on("click",markCompositeLineTextDash),r.append("svg:line").attr("x1",function(e,a){return drawCompositeLine("x1",a)}).attr("y1",function(e,a){return drawCompositeLine("y1",a)}).attr("x2",function(e){return charW*maxLen+2.3*charW}).attr("y2",charH+2).attr("style",function(e,a){return drawCompositeLine("styleMain",a)}).on("click",unmarkCompositeLine)):r.append("svg:text").attr("y",charH).attr("x",function(e){return charW*maxLen+charW/2}).attr("class","graphText3").text(function(e){return 0<e.length?e[e.length-1][5]:""}),drawCompositeNumbers()}function drawCompositeNumbers(){if(fFreeVerse){var e=calculateCompositeLines(),a=d3.select("#chart").select("svg");if(fLineSpacing)a.selectAll(".compositeCountT").data(e).enter().append("svg:text").attr("y",function(e){return e[0]*(charH+lineSpacing)+(charH+lineSpacing)+charH}).attr("x",function(e){return paddingLeft+8+charW*maxLen+2*charW}).attr("class","compositeCountT").attr("style",function(e){return drawCompositeLine("styleCompositeLineMaatraa",e)}).text(function(e){return e[1]}),a.selectAll(".compositeCountR").data(e).enter().append("svg:text").attr("y",function(e){return e[0]*(charH+lineSpacing)+(charH+lineSpacing)+charH+10}).attr("x",function(e){return paddingLeft+8+charW*maxLen+2*charW+20}).attr("class","compositeCountR").attr("style",function(e){return"fill:red;font-size:80%"}).text(function(e){return drawCompositeLine("compositeRemainderValue",e)});else a.selectAll(".compositeCountT").data(e).enter().append("svg:text").attr("y",function(e){return e[0]*charH+charH+charH}).attr("x",function(e){return paddingLeft+8+charW*maxLen+2*charW}).attr("class","compositeCountT").attr("style",function(e){return drawCompositeLine("styleCompositeLineMaatraa",e)}).text(function(e){return e[1]}),a.selectAll(".compositeCountR").data(e).enter().append("svg:text").attr("y",function(e){return e[0]*charH+charH+charH+10}).attr("x",function(e){return paddingLeft+8+charW*maxLen+2*charW+20}).attr("class","compositeCountR").attr("style",function(e){return"fill:red;font-size:80%"}).text(function(e){return drawCompositeLine("compositeRemainderValue",e)})}}function redrawCompositeNumbers(){d3.selectAll(".compositeCountT").remove(),d3.selectAll(".compositeCountR").remove(),drawCompositeNumbers()}function fnShowText(){showText=!showText,document.getElementById("chkShowText").checked=showText,draw()}function fnLineSpacing(){fLineSpacing=!fLineSpacing,draw()}function fnFreeVerseSupport(){(fFreeVerse=!fFreeVerse)?(document.getElementById("chkGhazal").disabled=!0,document.getElementById("spanFreeVerse").style.display="inline",initializeCompositeLines()):(document.getElementById("chkGhazal").disabled=!1,document.getElementById("spanFreeVerse").style.display="none"),draw()}function fnGhazal(){(fGhazal=!fGhazal)?(document.getElementById("chkFreeVerse").disabled=!0,calculateRadeef(),calculateKaafiyaa()):document.getElementById("chkFreeVerse").disabled=!1,draw()}function fnBaseCountChange(){var e=parseInt(document.getElementById("baseCount").value);0<e?e!=prevBaseCount&&(prevBaseCount=e,fFreeVerse&&redrawCompositeNumbers()):document.getElementById("baseCount").value=prevBaseCount}