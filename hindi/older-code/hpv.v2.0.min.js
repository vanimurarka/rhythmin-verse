function visualize(){splitNprocessPoem();if(fFreeVerse)initializeCompositeLines();draw();document.getElementById("divControls").style.display="block"}function initializeCompositeLines(){for(i=0;i<chars.length;i++){compositeLinesMarkingA[i]=[];if(chars[i].length>0){compositeLinesMarkingA[i][0]=chars[i][chars[i].length-1][5];compositeLinesMarkingA[i][1]=false}else{compositeLinesMarkingA[i][0]=0;compositeLinesMarkingA[i][1]=false}}}function calculateCompositeLines(){var e=false;var t=[];if(chars.length>1){for(i=1;i<chars.length;i++){if(compositeLinesMarkingA[i][1]){if(!e){e=true;var n=t.length;t[n]=[];t[n][0]=i-1;t[n][1]=chars[i-1][chars[i-1].length-1][5];t[n][1]+=chars[i][chars[i].length-1][5]}else{var n=t.length;t[n-1][1]+=chars[i][chars[i].length-1][5]}}else{if(e){e=false}}}}if(t.length>0)return t;else return false}function splitNprocessPoem(){var e=document.getElementById("pom").value;var t=e.split("\n");var n=prevText.split("\n");var r=0,i=0;var s=0;var o=0;maxLineLen=t.length;for(r=0;r<maxLineLen;r++){if(r<n.length&&n[r]==t[r]){chars[r][chars[r].length]="old"}else{chars[r]=[];for(i=0;i<t[r].length;i++){s=t[r].charCodeAt(i);o=chars[r].length;if(s>=2366&&s<=2381){chars[r][o-1][1]=t[r].substring(i,i+1);chars[r][o-1][3]=getVowData(chars[r][o-1][1])}else{if(s==32||s==44||s>=2309&&s<=2324){chars[r][o]=["",""];chars[r][o][0]=t[r].substring(i,i+1);chars[r][o][1]=t[r].substring(i,i+1)}if(s>=2325&&s<=2361||s>=2392&&s<=2399){chars[r][o]=["",""];chars[r][o][0]=t[r].substring(i,i+1);chars[r][o][1]="अ"}if(s==2306){chars[r][o]=["",""];chars[r][o][0]=t[r].substring(i,i+1);chars[r][o][1]="्"}o=chars[r].length-1;chars[r][o][2]=getConsData(chars[r][o][0]);chars[r][o][3]=getVowData(chars[r][o][1]);chars[r][o][4]=0;chars[r][o][5]=0}}chars[r][chars[r].length]="new"}}for(r=0;r<chars.length;r++){if(chars[r][chars[r].length-1]=="new"){for(i=0;i<chars[r].length-1;i++){switch(chars[r][i][3]){case 1:case 3:case 5:case 11:chars[r][i][4]=1;break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:chars[r][i][4]=2;break;case-1:{if(i==0){if(i==chars[r].length-2){chars[r][i][4]=halfLetterLen(0,chars[r][i],0)}else{chars[r][i][4]=halfLetterLen(0,chars[r][i],chars[r][i+1])}}else{if(i==chars[r].length-2){chars[r][i][4]=halfLetterLen(chars[r][i-1],chars[r][i],0)}else{chars[r][i][4]=halfLetterLen(chars[r][i-1],chars[r][i],chars[r][i+1])}}}}if(i==0){chars[r][i][5]=chars[r][i][4]}else{chars[r][i][5]=chars[r][i-1][5]+chars[r][i][4]}}if(chars[r].length>1){if(chars[r][i-1][5]>maxLen){maxLen=chars[r][i-1][5]}}}chars[r].pop()}if(t.length<chars.length){chars.length=t.length}prevText=e}function getVowData(e){switch(e){case" ":case",":return-10;case"अ":return 1;break;case"आ":case"ा":return 2;break;case"इ":case"ि":return 3;break;case"ई":case"ी":return 4;break;case"उ":case"ु":return 5;break;case"ऊ":case"ू":return 6;break;case"ए":case"े":return 7;break;case"ऐ":case"ै":return 8;break;case"ओ":case"ो":return 9;break;case"औ":case"ौ":return 10;break;case"ृ":return 11;break;default:return-1}return-1}function getConsData(e){switch(e){case" ":case",":return-10;case"अ":case"आ":case"इ":case"ई":case"उ":case"ऊ":case"ए":case"ऐ":case"ओ":case"औ":return 0;break;case"क":case"ख":case"ग":case"घ":case"ग़":case"ङ":return 1;break;case"च":case"छ":case"ज":case"झ":case"ञ":case"ज़":return 2;break;case"ट":case"ठ":case"ड":case"ढ":case"ण":case"ड़":case"ढ़":return 3;break;case"त":case"थ":case"द":case"ध":case"न":case"ं":return 4;break;case"प":case"फ":case"ब":case"भ":case"म":case"फ़":return 5;break;case"य":case"र":case"ल":case"व":return 6;break;case"श":case"ष":case"स":case"ह":return 7;break;default:return-1}return-1}function conColor(e){if(e[3]===-10)return"display: none";var t="";var n="";var r=0;var i="0.7";switch(e[2]){case 0:t="grey";break;case 1:t="rgb(255,0,0)";i="0.65";break;case 2:t="rgb(255,165,0)";break;case 3:t="rgb(255,255,0)";break;case 4:t="rgb(0,255,0)";i="1.0";break;case 5:t="rgb(0,220,255)";i="1.0";break;case 6:t="rgb(0,64,255)";break;case 7:t="rgb(143,0,255)";break;default:t="black"}if((e[3]%2==0||e[3]>6&&e[3]<11)&&mode=="edit"){n="1.0";r=2}else{n="0.3";r=1}if(e[3]==-1&&e[4]==0){t="black";n="1";i="0.7"}return"fill: "+t+"; fill-opacity: "+i+";stroke:black; stroke-width: "+r+"; stroke-opacity: "+n}function vowPath(e,t){var n="";var r=(e[5]-e[4])*charW;var i=charW*e[4];var s=charH;switch(e[3]){case-1:if(e[4]==0){i=4;s=4;r=r-2;n="M"+r+",0 L"+r+",-"+s+" L"+(r+i)+",-"+s+" L"+(r+i)+",0 z"}if(e[4]==1){n="M"+r+",0 L"+r+","+s+" L"+(r+i)+","+s+" L"+(r+i)+",0 z"}break;case 1:case 2:case 11:n="M"+r+",0 L"+r+","+s+" L"+(r+i)+","+s+" L"+(r+i)+",0 z";break;case 3:n="M"+r+","+s+" L"+r+","+s/2+" L"+(r+i/2)+",0"+" L"+(r+i)+","+s/2+" L"+(r+i)+","+s+" z";break;case 4:n="M"+r+","+s+" L"+(r+i/2)+",0"+" L"+(r+i)+","+s+" z";break;case 5:n="M"+r+",0 L"+r+","+s/2+"A"+i/2+","+i/2+" 0 0,0 "+(r+i)+","+s/2+" L"+(r+i)+",0 z";break;case 6:if(i==charW)n="M"+r+",0 A"+i/2+","+i+" 0 0,0 "+(r+i)+",0 z";else n="M"+r+",0 A"+i/2+","+i/2+" 0 0,0 "+(r+i)+",0 z";break;case 7:n="M"+r+",0 L"+r+","+s+" L"+(r+i)+","+s+" L"+(r+i)+","+s/2+" z";break;case 8:n="M"+r+",0 L"+r+","+s+" L"+(r+i)+","+s+" z";break;case 9:n="M"+r+","+s+" L"+r+","+s/2+"A"+i/2+","+s/2+" 0 0,1 "+(r+i)+","+s/2+" L"+(r+i)+","+s+" z";break;case 10:n="M"+r+","+s+" A"+i/2+","+s+" 0 0,1 "+(r+i)+","+s+" z";break;default:n="M"+r+",0 L"+r+","+s+" L"+(r+i)+","+s+" L"+(r+i)+",0 z";break}return n}function adjustCharLen(){var e=parseInt(this.getAttribute("id").substring(4));var t=parseInt(this.parentNode.getAttribute("id").substring(5));var n=0;if(chars[t][e][3]%2==0||chars[t][e][3]>6&&chars[t][e][3]<11){if(chars[t][e][4]==1){chars[t][e][4]=2;for(n=e;n<chars[t].length;n++)chars[t][n][5]=chars[t][n][5]+1;if(chars[t][n-1][5]>maxLen)maxLen=chars[t][n-1][5];draw();return}if(chars[t][e][4]==2){chars[t][e][4]=1;for(n=e;n<chars[t].length;n++)chars[t][n][5]=chars[t][n][5]-1;draw();return}}if(chars[t][e][3]==-1){if(chars[t][e][4]==0){chars[t][e][4]=1;for(n=e;n<chars[t].length;n++)chars[t][n][5]=chars[t][n][5]+1;if(chars[t][n-1][5]>maxLen)maxLen=chars[t][n-1][5];draw();return}if(chars[t][e][4]==1){chars[t][e][4]=0;for(n=e;n<chars[t].length;n++)chars[t][n][5]=chars[t][n][5]-1;draw();return}}}function markCompositeLineTextDash(){var e=parseInt(this.parentNode.getAttribute("id").substring(5));if(e<compositeLinesMarkingA.length-1&&!compositeLinesMarkingA[e+1][1]){compositeLinesMarkingA[e+1][1]=!compositeLinesMarkingA[e+1][1];draw()}}function unmarkCompositeLine(){var e=parseInt(this.parentNode.getAttribute("id").substring(5));if(e>0){compositeLinesMarkingA[e][1]=!compositeLinesMarkingA[e][1];draw()}}function charTxtPos(e,t){var n=(e[5]-e[4])*charW;var r=charW*e[4];return n+r/2}function charTxt(e){var t="";if(e[2]!=-10){if(e[2]==0||e[3]==1){t=e[0]}else{t=e[0]+e[1]}}return t}function halfLetterLen(e,t,n){if(e===0)return 0;if(e[2]===-10)return 0;pLD="";nLD="";if(t[0]=="म"&&n[0]=="ह")return 0;if(t[0]=="न"&&n[0]=="ह")return 0;switch(e[3]){case 1:case 3:case 5:case 11:pLD="l";break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:pLD="d";break}if(pLD==="l"){return 1}switch(n[3]){case 1:case 3:case 5:case 11:nLD="l";break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:nLD="d";break}if(pLD==="d"&&nLD==="d"){return 1}return 0}function drawCompositeLine(e,t){if(e=="x1"){if(t==0)return charW*maxLen+charW*2;if(compositeLinesMarkingA[t][1])return charW*maxLen+charW*2.3;else return charW*maxLen+charW*2}if(e=="y1"){if(compositeLinesMarkingA[t][1]){if(fLineSpacing)return-3;else return 0}else return charH}if(e=="styleSmall"){if(compositeLinesMarkingA[t][0]==0)return"display:none;";return"stroke:black;stroke-width:4;"}if(e=="styleMain"){if(compositeLinesMarkingA[t][0]==0||!compositeLinesMarkingA[t][1])return"display:none;";return"stroke:black;stroke-width:4;"}if(e=="styleCompositeLineMaatraa"){var n=parseInt(document.getElementById("baseCount").value);if(n>0){if(t[1]%n==0){return"fill:black"}else{return"fill:red"}}return"fill:black"}if(e=="compositeRemainderValue"){var n=parseInt(document.getElementById("baseCount").value);if(n>1){var r=t[1]%n;if(r!=0){var i=t[1]/n;var s=parseInt(i);var o=i-s;if(o<=.5)return"+"+r;else return"-"+((s+1)*n-t[1])}}return""}}function draw(){var e=d3.select("#chart");e.select("svg").remove();var t=e.append("svg").attr("width",function(){return fFreeVerse?charW*maxLen+120:charW*maxLen+100}).attr("height",maxLineLen*(charW+7)+(charW+7)+charW).attr("style","border: solid 1px #ddd;");if(fLineSpacing){var n=t.selectAll("g").data(chars).enter().append("svg:g").attr("transform",function(e,t){return"translate("+paddingLeft+","+(t*(charH+lineSpacing)+(charH+lineSpacing))+")"}).attr("id",function(e,t){return"gLine"+t})}else{var n=t.selectAll("g").data(chars).enter().append("svg:g").attr("transform",function(e,t){return"translate("+paddingLeft+","+(t*charH+charH)+")"}).attr("id",function(e,t){return"gLine"+t})}n.selectAll("path").data(function(e){return e}).enter().append("path").attr("id",function(e,t){return"char"+t}).attr("style",function(e,t){return conColor(e)}).attr("d",function(e,t){return vowPath(e,t)}).attr("title",function(e,t){return e[0]+e[1]}).on("click",adjustCharLen);if(showText){n.selectAll("text").data(function(e){return e}).enter().append("svg:text").attr("y",charH-2).attr("x",function(e,t){return charTxtPos(e)}).attr("class","graphText3").attr("text-anchor","middle").text(function(e){return charTxt(e)})}if(fFreeVerse){n.append("svg:text").attr("y",charH).attr("x",function(e){return charW*maxLen+charW}).attr("class","graphText3").text(function(e){return e.length>0?e[e.length-1][5]:""}).on("click",markCompositeLineTextDash);n.append("svg:line").attr("x1",function(e,t){return charW*maxLen+charW*2}).attr("y1",function(e,t){return charH+2}).attr("x2",function(e){return charW*maxLen+charW*2.3}).attr("y2",charH+2).attr("style",function(e,t){return drawCompositeLine("styleSmall",t)}).on("click",markCompositeLineTextDash);n.append("svg:line").attr("x1",function(e,t){return drawCompositeLine("x1",t)}).attr("y1",function(e,t){return drawCompositeLine("y1",t)}).attr("x2",function(e){return charW*maxLen+charW*2.3}).attr("y2",charH+2).attr("style",function(e,t){return drawCompositeLine("styleMain",t)}).on("click",unmarkCompositeLine)}else{n.append("svg:text").attr("y",charH).attr("x",function(e){return charW*maxLen+charW}).attr("class","graphText3").text(function(e){return e.length>0?e[e.length-1][5]:""})}drawCompositeNumbers()}function drawCompositeNumbers(){if(fFreeVerse){var e=calculateCompositeLines();var t=d3.select("#chart");var n=t.select("svg");if(fLineSpacing){var r=n.selectAll(".compositeCountT").data(e).enter().append("svg:text").attr("y",function(e){return e[0]*(charH+lineSpacing)+(charH+lineSpacing)+charH}).attr("x",function(e){return paddingLeft+8+charW*maxLen+charW*2}).attr("class","compositeCountT").attr("style",function(e){return drawCompositeLine("styleCompositeLineMaatraa",e)}).text(function(e){return e[1]});var i=n.selectAll(".compositeCountR").data(e).enter().append("svg:text").attr("y",function(e){return e[0]*(charH+lineSpacing)+(charH+lineSpacing)+charH+10}).attr("x",function(e){return paddingLeft+8+charW*maxLen+charW*2+20}).attr("class","compositeCountR").attr("style",function(e){return"fill:red;font-size:80%"}).text(function(e){return drawCompositeLine("compositeRemainderValue",e)})}else{var r=n.selectAll(".compositeCountT").data(e).enter().append("svg:text").attr("y",function(e){return e[0]*charH+charH+charH}).attr("x",function(e){return paddingLeft+8+charW*maxLen+charW*2}).attr("class","compositeCountT").attr("style",function(e){return drawCompositeLine("styleCompositeLineMaatraa",e)}).text(function(e){return e[1]});var i=n.selectAll(".compositeCountR").data(e).enter().append("svg:text").attr("y",function(e){return e[0]*charH+charH+charH+10}).attr("x",function(e){return paddingLeft+8+charW*maxLen+charW*2+20}).attr("class","compositeCountR").attr("style",function(e){return"fill:red;font-size:80%"}).text(function(e){return drawCompositeLine("compositeRemainderValue",e)})}}}function redrawCompositeNumbers(){d3.select(".compositeCountT").remove();d3.select(".compositeCountR").remove();drawCompositeNumbers()}function fnShowText(){showText=!showText;document.getElementById("chkShowText").checked=showText;draw()}function fnLineSpacing(){fLineSpacing=!fLineSpacing;draw()}function fnFreeVerseSupport(){fFreeVerse=!fFreeVerse;if(fFreeVerse){document.getElementById("spanFreeVerse").style.display="inline";initializeCompositeLines()}else{document.getElementById("spanFreeVerse").style.display="none"}draw()}function fnBaseCountChange(){var e=parseInt(document.getElementById("baseCount").value);if(e>0){if(e!=prevBaseCount){prevBaseCount=e;if(fFreeVerse){redrawCompositeNumbers()}}}else{document.getElementById("baseCount").value=prevBaseCount}}var charW=24;var charH=24;var paddingLeft=10;var lineSpacing=7;var mode="analyze";var showText=true;var prevText="";var prevBaseCount=1;var fLineSpacing=true;var fFreeVerse=false;var selWord=1;var chars=[];var maxLen=0;var maxLineLen=0;var compositeLinesMarkingA=[]