class cChar{constructor(e,t){this.mainChar=e,this.mainCharCode=t,this.vowelChar="",this.vowelNumber=0,this.index=0,this.maatraa=0,this.systemMaatraa=0,this.maatraaCumulative=0,this.isRadeef=!1,this.isKaafiyaa=!1,this.isHindi=!1,this.rhymeLevel=0,this.rhymeGroup=-1,(32==t||44==t||t>=2309&&t<=2324)&&(this.vowel=e),(t>=2325&&t<=2361||t>=2392&&t<=2399)&&(this.vowel="अ"),2306==t&&(this.vowel="्")}replaceMainChar(e){if("़"==e)switch(this.mainChar){case"क":this.mainChar="क़",this.mainCharCode=2392;break;case"ख":this.mainChar="ख़",this.mainCharCode=2393;break;case"ग":this.mainChar="ग़",this.mainCharCode=2394;break;case"ज":this.mainChar="ज़",this.mainCharCode=2395;break;case"ड":this.mainChar="ड़",this.mainCharCode=2396;break;case"ढ":this.mainChar="ढ़",this.mainCharCode=2397;break;case"फ":this.mainChar="फ़",this.mainCharCode=2398}}set vowel(e){switch(this.vowelChar=e,e){case"्":this.vowelNumber=-1;break;case"अ":this.vowelNumber=1;break;case"आ":case"ा":this.vowelNumber=2;break;case"इ":case"ि":this.vowelNumber=3;break;case"ई":case"ी":this.vowelNumber=4;break;case"उ":case"ु":this.vowelNumber=5;break;case"ऊ":case"ू":this.vowelNumber=6;break;case"ए":case"े":this.vowelNumber=7;break;case"ऐ":case"ै":this.vowelNumber=8;break;case"ओ":case"ो":this.vowelNumber=9;break;case"औ":case"ौ":this.vowelNumber=10;break;case"ऑ":case"ॉ":this.vowelNumber=11;break;case"ऋ":case"ृ":this.vowelNumber=12;break;default:this.vowelNumber=-10}switch(this.vowelNumber){case 1:case 3:case 5:case 12:this.maatraa=1,this.systemMaatraa=1,this.isHindi=!0;break;case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:case 11:this.maatraa=2,this.systemMaatraa=2,this.isHindi=!0;break;default:this.maatraa=0,this.systemMaatraa=0}}isHalfLetter(){return-1==this.vowelNumber}isPureVowel(){return this.mainChar==this.vowelChar}isLaghu(){switch(this.vowelNumber){case 1:case 3:case 5:case 12:return!0;default:return!1}}isDeergha(){switch(this.vowelNumber){case 2:case 4:case 6:case 8:case 10:case 7:case 9:case 10:return!0;default:return!1}}calculateHalfLetterLen(e=!1,t=!1){return e?-10===e.vowelNumber?(this.maatraa=0,this.systemMaatraa=0,this.maatraa):"म"==this.mainChar&&"ह"==t.mainChar?(this.maatraa=0,this.systemMaatraa=0,this.maatraa):"न"==this.mainChar&&"ह"==t.mainChar?(this.maatraa=0,this.systemMaatraa=0,this.maatraa):e.isLaghu()?(this.maatraa=1,this.systemMaatraa=1,this.maatraa):t&&e.isDeergha()&&t.isDeergha()?(this.maatraa=1,this.systemMaatraa=1,this.maatraa):0:(this.maatraa=0,this.systemMaatraa=0,this.maatraa)}adjustCharMaatraa(){(this.vowelNumber%2==0||this.vowelNumber>6&&this.vowelNumber<12)&&(1==this.maatraa?this.maatraa=2:this.maatraa=1),-1==this.vowelNumber&&(0==this.maatraa?this.maatraa=1:this.maatraa=0)}get text(){let e="";return-10!=this.vowelNumber&&0!=this.vowelNumber&&(e=this.isPureVowel()||1==this.vowelNumber?this.mainChar:this.mainChar+this.vowelChar),e}get joinedConsonantVowel(){return this.mainChar==this.vowelChar?this.vowelChar:"अ"==this.vowelChar?this.mainChar:this.mainChar+this.vowelChar}compare(e){return this.text==e.text?"all":!(this.vowelNumber!=e.vowelNumber||this.mainChar==e.mainChar||!this.isHindi||!e.isHindi)&&"vowel"}}class cLine{constructor(){this.characters=new Array,this.count=0,this.maatraa=0,this.isComposite=!1,this.rhymeFound=!1,this.rhymeGroup=0,this.rhymeLength=0}lastCharVowel(e){const t=this.characters[this.count-1],a=t.maatraa;t.vowel=e,this.maatraa+=t.maatraa-a,t.maatraaCumulative+=t.maatraa-a}changeLastCharConsonant(e){this.characters[this.count-1].replaceMainChar(e)}push(e){e.index=this.count,0==e.index?e.maatraaCumulative=e.maatraa:e.maatraaCumulative=this.characters[this.count-1].maatraaCumulative+e.maatraa,this.characters.push(e),this.maatraa+=e.maatraa,this.count++}charByIndex(e){return this.characters[e]}charByReverseIndex(e){return(e=this.count-1-e)>0&&this.characters[e]}previousChar(e){return 0!=e.index&&this.count>1&&this.characters[e.index-1]}nextChar(e){return this.count>1&&e.index<this.count-1&&this.characters[e.index+1]}getLastChar(){return 0!=this.count&&this.characters[this.count-1]}getHalfLetters(){return this.characters.filter(function(e){return e.isHalfLetter()})}calculateHalfLettersMaatraa(){const e=this.getHalfLetters();let t,a=0;for(t=0;t<e.length;t++){const r=e[t];if(a=0,0==r.index)a=r.calculateHalfLetterLen();else{const e=this.previousChar(r),t=this.nextChar(r);a=r.calculateHalfLetterLen(e,t)}if(a>0){let e;for(this.maatraa+=a,r.maatraaCumulative+=a,e=r.index+1;e<this.count;e++)this.characters[e].maatraaCumulative++}}}adjustCharMaatraa(e){let t=this.charByIndex(e),a=t.maatraa;t.adjustCharMaatraa();let r,i=t.maatraa-a;for(this.maatraa+=i,r=e;r<this.count;r++)this.charByIndex(r).maatraaCumulative+=i;return this.maatraa}doesItRhyme(e,t){let a=0,r=0,i=[],s=[];for(;;){let t,n;if(!(t=this.charByReverseIndex(a)))return!1;if(t.isHindi){if(!(n=e.charByReverseIndex(r)))return!1;if(n.isHindi){if("all"==t.compare(n)){i[i.length]=[a,2],s[s.length]=[r,2],a++,r++;break}return!1}r++}else a++}let n,h,o=1,l=0;for(;n=this.charByReverseIndex(a);){if(!n.isHindi){a++;continue}if(!(h=e.charByReverseIndex(r)))break;if(!h.isHindi){r++;continue}let t=n.compare(h);if("all"==t&&0==l)i[i.length]=[a,2],s[s.length]=[r,2],a++,r++,o++;else{if("vowel"!=t)break;i[i.length]=[a,1],s[s.length]=[r,1],a++,r++,l++}}if(o+l>1){let r=o+l;if(r>this.rhymeLength)for(a=0;a<i.length;a++){let e=this.charByReverseIndex(i[a][0]);e.rhymeLevel=i[a][1],e.rhymeGroup=t}if(r>e.rhymeLength)for(a=0;a<s.length;a++){let r=e.charByReverseIndex(s[a][0]);r.rhymeLevel=s[a][1],r.rhymeGroup=t}return r}return!1}}class compositeLine{constructor(e){this.originalLineIdx=e,this.maatraa=0,this.remainder=0}}class cPoem{constructor(e){this.originalText=e,this.lines=new Array,this.lineCount=0,this.maxLineLen=0,this.compositeLines=[],this.baseCount=1,this.radeefTruncated=0,this.radeefArray=[]}pushLine(e){this.lines.push(e),this.lineCount++,this.maxLineLen<e.maatraa&&(this.maxLineLen=e.maatraa)}get text(){return this.originalText}adjustCharMaatraa(e,t){let a=this.lines[e].adjustCharMaatraa(t);this.maxLineLen<a&&(this.maxLineLen=a)}setComposite(e){this.lines[e].isComposite=!this.lines[e].isComposite,this.calculateCompositeMaatraa()}setBaseCount(e){this.baseCount=e,this.calculateCompositeMaatraa()}calculateCompositeMaatraa(){let e,t=!1;if(this.compositeLines.length=0,this.lineCount>1){let e=0;for(e=1;e<this.lines.length;e++)if(this.lines[e].isComposite){let a=this.compositeLines.length;t?this.compositeLines[a-1].maatraa+=this.lines[e].maatraa:(t=!0,this.compositeLines[a]=new compositeLine(e-1),this.compositeLines[a].maatraa=this.lines[e-1].maatraa,this.compositeLines[a].maatraa+=this.lines[e].maatraa),a=this.compositeLines.length,this.compositeLines[a-1].maatraa%this.baseCount==0?this.compositeLines[a-1].multipleOfBaseCount=!0:this.compositeLines[a-1].multipleOfBaseCount=!1}else t&&(t=!1)}for(e=0;e<this.compositeLines.length;e++)this.calculateRemainder(e)}calculateRemainder(e){if(this.baseCount>1){let t=this.compositeLines[e].maatraa,a=t%this.baseCount;if(0!=a){let r=t/this.baseCount,i=parseInt(r),s=r-i;this.compositeLines[e].remainder=s<=.5?a:-1*((i+1)*this.baseCount-t)}}else this.compositeLines[e].remainder=0}calculateRadeef(){let e,t,a="";this.radeefArray=[];let r=!1,i=this.lines[0].count-1,s=this.lines[1].count-1;for(;!r&&i>=0&&s>=0;)(e=this.lines[0].characters[i].joinedConsonantVowel)==(t=this.lines[1].characters[s].joinedConsonantVowel)?(a=e+a,this.radeefArray[this.radeefArray.length]=[],this.radeefArray[this.radeefArray.length-1][0]=this.lines[0].characters[i].mainChar,this.radeefArray[this.radeefArray.length-1][1]=this.lines[0].characters[i].vowelChar,i--,s--):r=!0;let n=a.substr(a.indexOf(" ")+1);if(a!==n){for(this.radeefTruncated=1,i=this.radeefArray.length-1;i>=0&&" "!=this.radeefArray[i][0];i--);this.radeefArray.length=i,a=n}let h=this.radeefArray.length;for(i=0;i<this.lines.length;i++){let e=!1;i<=1&&(e=!0),i>1&&i<this.lines.length-1&&0==this.lines[i+1].characters.length&&(e=!0),i==this.lines.length-1&&(e=!0);let t=this.lines[i].characters.length;if(e&&t>h)for(let e=0;e<h&&(this.radeefArray[e][0]==this.lines[i].characters[t-1-e].mainChar&&this.radeefArray[e][1]==this.lines[i].characters[t-1-e].vowelChar);e++)this.lines[i].characters[t-1-e].isRadeef=!0}}calculateKaafiyaa(){let e,t,a,r=this.radeefArray.length,i=!1,s=[],n=this.lines[0].characters.length-1-r,h=this.lines[1].characters.length-1-r;for(;!i&&n>=0&&h>=0;)(t=this.lines[0].characters[n].vowelNumber)==(a=this.lines[1].characters[h].vowelNumber)?(e=t+e,s[s.length]=t,n--,h--):i=!0;-10==s[0]&&s.splice(0,1);let o=s.length;for(n=0;n<this.lines.length;n++){let e=!1;n<=1&&(e=!0),n>1&&n<this.lines.length-1&&0==this.lines[n+1].characters.length&&(e=!0),n==this.lines.length-1&&(e=!0);let t=this.lines[n].characters.length;if(e&&t>r+o+this.radeefTruncated)for(h=0;h<o&&s[h]==this.lines[n].characters[t-1-r-this.radeefTruncated-h].vowelNumber;h++)this.lines[n].characters[t-1-r-this.radeefTruncated-h].isKaafiyaa=!0}}findRhymingLines(){if(this.lineCount<2)return;let e=0,t=1,a=!1,r=0,i=!1;for(e=0;e<this.lineCount-1;e++){let s=this.lines[e];for(a=!1,t=e+1,this.lineCount<=t&&(a=!0);!a;){let e=this.lines[t],n=s.doesItRhyme(e,r);n&&(s.rhymeLength<n&&(s.rhymeLength=n,s.rhymeFound=!0,s.rhymeGroup=r,i=!0),e.rhymeLength<n&&(e.rhymeLength=n,e.rhymeFound=!0,e.rhymeGroup=r,i=!0)),t++,this.lineCount<=t&&(a=!0,i&&(i=!1,r++))}}}}class cVisual{constructor(e){this.availableW=e,this.mode="fixed",this.userMode="",this.width=0,this.ratio=1}setMode(e,t,a){this.mode=e,this.width=t,this.ratio=a}}var oPoem,oPrevPoem,oVisual,rhymeColors=["#046ffd","#ff8004","rgb(0,255,0)","#fd4c48","#9203ff","#ff00a0","#a4ff00"];function visualize(e,t){if(splitNprocessPoem(e),fGhazal&&(oPoem.calculateRadeef(),oPoem.calculateKaafiyaa()),fFreeVerse){let e=parseInt(document.getElementById("baseCount").value);oPoem.setBaseCount(e)}oVisual=new cVisual(t),draw(),document.getElementById("divControls").style.display="block"}function redraw(e){oVisual=new cVisual(e),draw()}function splitNprocessPoem(e){oPrevPoem=oPoem;const t=(oPoem=new cPoem(e)).text.split("\n");let a=[];void 0!==oPrevPoem&&(a=oPrevPoem.originalText.split("\n"));const r=t.length;let i;for(i=0;i<r;i++)if(i<a.length&&t[i]==a[i])oPoem.pushLine(oPrevPoem.lines[i]);else{const e=new cLine;for(t[i]=t[i].replace(/[^\u0900-\u097F ]/g," "),t[i]=t[i].replace("।"," "),t[i]=t[i].replace(/\s+/g," "),t[i]=t[i].trim(),k=0;k<t[i].length;k++)if(charCode=t[i].charCodeAt(k),2364==charCode)e.changeLastCharConsonant(t[i].substring(k,k+1));else if(charCode>=2366&&charCode<=2381)e.lastCharVowel(t[i].substring(k,k+1));else{var s=t[i].substring(k,k+1);const a=new cChar(s,charCode);e.push(a)}e.calculateHalfLettersMaatraa(),oPoem.pushLine(e)}oPoem.findRhymingLines(),console.log(oPoem)}var charW=20,charH=20,paddingLeft=2,lineSpacing=5,fShowText=!0,fLineSpacing=!0,fFreeVerse=!1,fGhazal=!1;function initSvgFixed(e,t){return d3.select("#chart").append("svg").attr("width",function(){return e}).attr("height",function(){return t}).attr("style","border-bottom: solid 1px #ddd;")}function initSvgFlex(e){return d3.select("#chart").append("svg").attr("viewBox",e).attr("preserveAspectRatio","xMidYMid meet").attr("style","border-bottom: solid 1px #ddd;")}function draw(){const e=oPoem.maxLineLen,t=oPoem.lineCount;d3.select("#chart").select("svg").remove();const a=fFreeVerse?charW*e+70:charW*e+30,r=fLineSpacing?t*(charH+lineSpacing)+2*charH:t*charH+2*charH,i="0 0 "+a+" "+r,s=oVisual.availableW/a;var n;if(oVisual.availableW<=500?oVisual.setMode("flexible",a,s):s>=.6&&s<=1?oVisual.setMode("flexible",a,s):oVisual.setMode("fixed",a,s),n=""==oVisual.userMode?"fixed"==oVisual.mode?initSvgFixed(a,r):initSvgFlex(i):"fixed"==oVisual.userMode?initSvgFixed(a,r):initSvgFlex(i),fLineSpacing)var h=n.selectAll("g").data(oPoem.lines).enter().append("svg:g").attr("transform",function(e,t){return"translate("+paddingLeft+","+(t*(charH+lineSpacing)+(charH+lineSpacing))+")"}).attr("id",function(e,t){return"gLine"+t});else h=n.selectAll("g").data(oPoem.lines).enter().append("svg:g").attr("transform",function(e,t){return"translate("+paddingLeft+","+(t*charH+charH)+")"}).attr("id",function(e,t){return"gLine"+t});fShowText&&h.selectAll("text").data(function(e){return e.characters}).enter().append("svg:text").attr("y",charH-2).attr("x",function(e){return drawCharTxtPos(e)}).attr("class","graphText3").attr("text-anchor","middle").text(function(e){return e.text}),h.selectAll("path").data(function(e){return e.characters}).enter().append("path").attr("id",function(e,t){return"char"+t}).attr("style",function(e,t){return drawStyleCharBlock(e,fGhazal?"ghazal":"consonant")}).attr("d",function(e,t){return drawVowPath(e,t)}).attr("title",function(e,t){return e.mainChar+e.vowelChar}).on("click",adjustCharLen),fFreeVerse?(h.append("svg:text").attr("y",charH).attr("x",function(t){return charW*e+5}).attr("class","graphText3").text(function(e){return e.maatraa>0?e.maatraa:""}).on("click",markCompositeLine),h.append("svg:line").attr("x1",function(t,a){return charW*e+(charW+5)}).attr("y1",function(e,t){return charH-2}).attr("x2",function(t){return charW*e+(charW+10)}).attr("y2",charH-2).attr("style",function(e,t){return drawFreeVerseDashStyle(t)}).on("click",markCompositeLine),h.append("svg:line").attr("x1",function(e,t){return drawCompositeLineMarker("x1",t)}).attr("y1",function(e,t){return drawCompositeLineMarker("y1",t)}).attr("x2",function(t){return charW*e+(charW+12)}).attr("y2",charH+2).attr("style",function(e,t){return drawCompositeLineMarker("style",t)}).on("click",unmarkCompositeLine)):h.append("svg:text").attr("y",charH).attr("x",function(t){return charW*e+5}).attr("class","graphText3").text(function(e){return e.maatraa>0?e.maatraa:""}),fFreeVerse&&drawCompositeNumbers()}function drawCharTxtPos(e){return(e.maatraaCumulative-e.maatraa)*charW+charW*e.maatraa/2}function drawStyleCharBlock(e,t){if(-10===e.vowelNumber)return"display: none";var a="rgb(0,220,255)",r="0.3",i="0.2",s="black";return"consonant"==t&&(e.maatraa==e.systemMaatraa?e.rhymeLevel>0&&(i="0.4",void 0===(a=rhymeColors[e.rhymeGroup])&&(a="white",i="0.2")):(a="yellow",i="0.5")),"ghazal"==t&&(e.isRadeef&&(a="rgb(0,220,255)",i="0.5"),e.isKaafiyaa&&(a="rgb(0,255,0)",i="0.5")),-1==e.vowelNumber&&0==e.maatraa&&(a="black",i="0.6",e.maatraa!==e.systemMaatraa&&(a="yellow",i="1",s="orange",r="1")),"fill: "+a+"; fill-opacity: "+i+";stroke:"+s+"; stroke-width: 1; stroke-opacity: "+r}function drawVowPath(e,t){var a=(e.maatraaCumulative-e.maatraa)*charW,r=charW*e.maatraa,i=charH;return-1==e.vowelNumber&&0==e.maatraa?"M"+(a-=2)+",0 L"+a+",-"+(i=4)+" L"+(a+(r=4))+",-"+i+" L"+(a+r)+",0 z":"M"+a+",0 L"+a+","+i+" L"+(a+r)+","+i+" L"+(a+r)+",0 z"}function fnShowText(){fShowText=!fShowText,document.getElementById("chkShowText").checked=fShowText,draw()}function drawFreeVerseDashStyle(e){return 0==oPoem.lines[e].maatraa?"display:none;":"stroke:black;stroke-width:8;"}function fnFreeVerseSupport(){if(fFreeVerse=!fFreeVerse){document.getElementById("chkGhazal").disabled=!0,document.getElementById("spanFreeVerse").style.display="inline";let e=parseInt(document.getElementById("baseCount").value);oPoem.setBaseCount(e)}else document.getElementById("chkGhazal").disabled=!1,document.getElementById("spanFreeVerse").style.display="none";draw()}function fnFit(e){var t=e.checked;oVisual.userMode=t?"flexible":"fixed",draw()}function drawCompositeLineMarker(e,t){const a=oPoem.maxLineLen;return"x1"==e?0==t?charW*a+2*charW:oPoem.lines[t].isComposite?charW*a+(charW+12):charW*a+2*charW:"y1"==e?oPoem.lines[t].isComposite?fLineSpacing?-11:0:charH-2:"style"==e?0!=oPoem.lines[t].maatraa&&oPoem.lines[t].isComposite?"stroke:green;stroke-width:6;":"display:none;":void 0}function drawCompositeNumbers(){const e=oPoem.maxLineLen;let t=d3.select("#chart").select("svg"),a=0;a=fLineSpacing?charH+lineSpacing:charH;t.selectAll(".compositeCountT").data(oPoem.compositeLines).enter().append("svg:text").attr("y",function(e){return e.originalLineIdx*a+a+charH}).attr("x",function(t){return paddingLeft+charW*e+(charW+20)}).attr("class","compositeCountT").attr("style",function(e){return e.multipleOfBaseCount?"fill:black":"fill:red"}).text(function(e){return e.maatraa}),t.selectAll(".compositeCountR").data(oPoem.compositeLines).enter().append("svg:text").attr("y",function(e){return e.originalLineIdx*a+a+charH+10}).attr("x",function(t){return paddingLeft+charW*e+(charW+20+10)}).attr("class","compositeCountR").attr("style",function(e){return 0!=e.remainder?"fill:red;font-size:80%":"display:none"}).text(function(e){return e.remainder>0?"+"+e.remainder:e.remainder})}function fnLineSpacing(){fLineSpacing=!fLineSpacing,draw()}function adjustCharLen(){var e=parseInt(this.getAttribute("id").substring(4)),t=parseInt(this.parentNode.getAttribute("id").substring(5));oPoem.adjustCharMaatraa(t,e),draw()}function markCompositeLine(){let e=parseInt(this.parentNode.getAttribute("id").substring(5));e<oPoem.lines.length-1&&!oPoem.lines[e+1].isComposite&&(oPoem.setComposite(e+1),draw())}function unmarkCompositeLine(){var e=parseInt(this.parentNode.getAttribute("id").substring(5));e>0&&(oPoem.setComposite(e),draw())}function fnBaseCountChange(){let e=parseInt(document.getElementById("baseCount").value);e>0?e!=oPoem.baseCount&&(oPoem.setBaseCount(e),draw()):document.getElementById("baseCount").value=prevBaseCount}function fnGhazal(){(fGhazal=!fGhazal)?(document.getElementById("chkFreeVerse").disabled=!0,oPoem.calculateRadeef(),oPoem.calculateKaafiyaa()):document.getElementById("chkFreeVerse").disabled=!1,draw()}