let charW=20,charH=20,paddingLeft=7,lineSpacing=5,fShowText=!0,fLineSpacing=!0,fFreeVerse=!1,fGhazal=!1,fRhymingLines=!1,dPoem,lineRhythmTotal=0;var oVisual,rhymeColors=["#ff8004","#fd4c48","#9203ff","#ff00a0","#a4ff00"];class cVisual{constructor(t){this.availableW=t,this.mode="fixed",this.userMode="",this.width=0,this.ratio=1}setMode(t,e,r){this.mode=t,this.width=e,this.ratio=r}}function initSvgFixed(t,e){return d3.select("#chart").append("svg").attr("width",function(){return t}).attr("height",function(){return e}).attr("style","border-bottom: solid 1px #ddd;background-color:white")}function initSvgFlex(t){return d3.select("#chart").append("svg").attr("viewBox",t).attr("preserveAspectRatio","xMidYMid meet").attr("style","border-bottom: solid 1px #ddd;background-color:white")}function visualize(t,e,r){fGhazal=fFreeVerse=!1,"GHAZAL"==(dPoem=t).poemType&&(fGhazal=!0),"FREEVERSE"==dPoem.poemType&&(fFreeVerse=!0),oVisual=new cVisual(e),draw()}function draw(){let t=dPoem.maxLineLen,e=dPoem.lines.length,r=void 0!==dPoem.pattern&&dPoem.pattern.subUnits.length>0,a=r?1:0;d3.select("#chart").select("svg").remove();let n=fFreeVerse?charW*t+80:charW*t+40,i=fLineSpacing?(e+a)*(charH+lineSpacing)+2*charH:(e+a)*charH+2*charH,o="0 0 "+n+" "+i,s=oVisual.availableW/n;if(oVisual.availableW<=500?oVisual.setMode("flexible",n,s):s>=.6&&s<=1?oVisual.setMode("flexible",n,s):oVisual.setMode("fixed",n,s),l=""==oVisual.userMode?"fixed"==oVisual.mode?initSvgFixed(n,i):initSvgFlex(o):"fixed"==oVisual.userMode?initSvgFixed(n,i):initSvgFlex(o),r)var l,c=l.append("svg:g").attr("transform",function(t,e){return fLineSpacing?"translate("+paddingLeft+","+(charH+lineSpacing)+")":"translate("+paddingLeft+","+charH+")"}).attr("id",function(t,e){return"gPattern"});if(fLineSpacing)var h=l.selectAll("g.gLine").data(dPoem.lines).enter().append("svg:g").attr("transform",function(t,e){return"translate("+paddingLeft+","+((e+a)*(charH+lineSpacing)+(a+charH+lineSpacing))+")"}).attr("id",function(t,e){return"gLine"+e}).attr("class","gLine");else var h=l.selectAll("g.gLine").data(dPoem.lines).enter().append("svg:g").attr("transform",function(t,e){return"translate("+paddingLeft+","+((e+a)*charH+charH)+")"}).attr("id",function(t,e){return"gLine"+e}).attr("class","gLine");fShowText&&(r&&c.selectAll("text").data(dPoem.pattern.subUnits).enter().append("svg:text").attr("y",charH-2).attr("x",function(t,e){return drawCharTxtPos(t,e)}).attr("class","graphText3").attr("text-anchor","middle").text(function(t){return t.txt}),h.selectAll("text").data(function(t){return t.subUnits}).enter().append("svg:text").attr("y",charH-2).attr("x",function(t,e){return drawCharTxtPos(t,e)}).attr("class","graphText3").attr("text-anchor","middle").text(function(t){return t.txt})),r&&c.selectAll("path").data(dPoem.pattern.subUnits).enter().append("path").attr("style",function(t,e){return drawStyleCharBlock(t,"consonant")}).attr("d",function(t,e){return drawCharBlock(t,e)}).attr("title",function(t,e){return t.txt}),h.selectAll("path").data(function(t){return t.subUnits}).enter().append("path").attr("id",function(t,e){return"char"+e}).attr("style",function(t,e){return fGhazal?drawStyleCharBlock(t,"ghazal"):drawStyleCharBlock(t,"consonant")}).attr("d",function(t,e){return drawCharBlock(t,e)}).attr("title",function(t,e){return t.txt}).on("click",adjustCharLen),fFreeVerse?(h.append("svg:text").attr("y",charH).attr("x",function(e){return charW*t+5}).attr("class","graphText3").text(function(t){return t.rhythmAmtCumulative>0?t.rhythmAmtCumulative:""}).on("click",markCompositeLine),h.append("svg:line").attr("x1",function(e,r){return charW*t+(charW+5)}).attr("y1",function(t,e){return charH-2}).attr("x2",function(e){return charW*t+(charW+10)}).attr("y2",charH-2).attr("style",function(t,e){return drawFreeVerseDashStyle(e)}).on("click",markCompositeLine),h.append("svg:line").attr("x1",function(t,e){return drawCompositeLineMarker("x1",e)}).attr("y1",function(t,e){return drawCompositeLineMarker("y1",e)}).attr("x2",function(e){return charW*t+(charW+12)}).attr("y2",charH+2).attr("style",function(t,e){return drawCompositeLineMarker("style",e)}).on("click",unmarkCompositeLine),drawCompositeNumbers()):(r&&c.append("svg:text").attr("y",charH).attr("x",function(e){return charW*t+5}).text(function(t){return dPoem.pattern.rhythmAmtCumulative>0?dPoem.pattern.rhythmAmtCumulative:""}),h.append("svg:text").attr("y",charH).attr("x",function(e){return charW*t+5}).text(function(t){return t.rhythmAmtCumulative>0?t.rhythmAmtCumulative:""}))}function drawCharBlock(t,e){0==e&&(lineRhythmTotal=0);let r="",a=lineRhythmTotal*charW;lineRhythmTotal+=t.rhythmAmt;let n=charW*t.rhythmAmt,i=charH;return t.isHalfLetter&&0==t.rhythmAmt?(a-=2,r="M"+a+",0 L"+a+",-"+(i=4)+" L"+(a+(n=4))+",-"+i+" L"+(a+n)+",0 z"):r="M"+a+",0 L"+a+","+i+" L"+(a+n)+","+i+" L"+(a+n)+",0 z",r}function drawCharTxtPos(t,e){0==e&&(lineRhythmTotal=0);let r=lineRhythmTotal*charW,a=charW*t.rhythmAmt;return lineRhythmTotal+=t.rhythmAmt,r+a/2}function drawStyleCharBlock(t,e){if(" "==t.txt)return -1==t.rhythmPatternValue?"stroke:rgb(0,118,255);stroke-width:3":"display: none";var r="rgb(0,220,255)",a="0.3",n="0.4",i="black";if("consonant"==e){if(t.rhythmAmt==t.systemRhythmAmt){if(2==t.systemRhythmAmt&&(r="rgb(0,255,0)",n="0.4"),1.5==t.rhythmPatternValue&&(r="rgb(0,255,0)",n="0.2"),t.rhymeLevel>0&&fRhymingLines&&(r=rhymeColors[t.rhymeGroup],n="0.4",void 0===r&&(r="white",n="0.2")),void 0!==t.belongsToGan&&t.belongsToGan.length>0)switch(t.belongsToGan){case ganType.y:r="#FF99FF",n="0.5";break;case ganType.m:r="#00aa00",n="0.4";break;case ganType.t:r="#bd7ebe",n="0.5";break;case ganType.r:r="rgb(255,0,0)",n="0.4";break;case ganType.j:r="#ffb55a",n="0.5";break;case ganType.b:r="#7eb0d5",n="0.5";break;case ganType.n:r="rgb(0,0,255)",n="0.3";break;case ganType.s:r="#CC9900",n="0.4";break;case ganType.l:n="0.5";break;case ganType.g:break;default:r="rgb(255,255,255)",n="0.4"}t.isHalfLetter&&0==t.rhythmAmt&&(r="black",n="0.7")}else r="yellow",n="0.5"}return"ghazal"==e&&(t.rhythmAmt==t.systemRhythmAmt?("r"==t.rk&&(r="rgb(0,100,255)",n="0.5"),"k"==t.rk&&(r="rgb(0,255,0)",n="0.5")):(r="yellow",n="0.5")),-1==t.vowelNumber&&0==t.maatraa&&(r="black",n="0.6",t.maatraa!==t.systemMaatraa&&(r="yellow",n="1",i="orange",a="1")),"fill: "+r+"; fill-opacity: "+n+";stroke:"+i+"; stroke-width: 1; stroke-opacity: "+a}function adjustCharLen(){let t=parseInt(this.getAttribute("id").substring(4));callAdjustMaatraa(parseInt(this.parentNode.getAttribute("id").substring(5)),t)}function markCompositeLine(){let t=parseInt(this.parentNode.getAttribute("id").substring(5));t<dPoem.lines.length-1&&!dPoem.lines[t+1].isComposite&&callSetComposite(t+1)}function drawFreeVerseDashStyle(t){return 0==dPoem.lines[t].maatraa?"display:none;":"stroke:black;stroke-width:8;"}function drawCompositeLineMarker(t,e){let r=dPoem.maxLineLen;return"x1"==t?0==e?charW*r+2*charW:dPoem.lines[e].isComposite?charW*r+(charW+12):charW*r+2*charW:"y1"==t?dPoem.lines[e].isComposite?fLineSpacing?-11:0:charH-2:"style"==t?0!=dPoem.lines[e].maatraa&&dPoem.lines[e].isComposite?"stroke:green;stroke-width:6;":"display:none;":void 0}function unmarkCompositeLine(){var t=parseInt(this.parentNode.getAttribute("id").substring(5));t>0&&callSetComposite(t)}function drawCompositeNumbers(){let t=dPoem.maxLineLen,e=d3.select("#chart").select("svg"),r=0;r=fLineSpacing?charH+lineSpacing:charH,e.selectAll(".compositeCountT").data(dPoem.compositeLines).enter().append("svg:text").attr("y",function(t){return t.originalLineIdx*r+r+charH}).attr("x",function(e){return paddingLeft+charW*t+(charW+20)}).attr("class","compositeCountT").attr("style",function(t){return t.multipleOfBaseCount?"fill:black":"fill:red"}).text(function(t){return t.rhythmAmtCumulative}),e.selectAll(".compositeCountR").data(dPoem.compositeLines).enter().append("svg:text").attr("y",function(t){return t.originalLineIdx*r+r+charH+10}).attr("x",function(e){return paddingLeft+charW*t+(charW+20+10)}).attr("class","compositeCountR").attr("style",function(t){return 0!=t.remainder?"fill:red;font-size:80%":"display:none"}).text(function(t){return t.remainder>0?"+"+t.remainder:t.remainder})}function fnFit(t){t.checked?oVisual.userMode="flexible":oVisual.userMode="fixed",draw()}function fnLineSpacing(){fLineSpacing=!fLineSpacing,draw()}function fnShowText(){fShowText=!fShowText,draw()}function saveSVG(){var t=document.getElementById("chart").querySelector("svg"),e=document.createElement("canvas"),r=new XMLSerializer().serializeToString(t);if(-1==r.search("viewBox")){var a=t.getBoundingClientRect().width,n=t.getBoundingClientRect().height;e.width=a,e.height=n+10;var i='<svg xmlns="http://www.w3.org/2000/svg" width="'+a+'" height="';r=r.substring(i.length+n.toString().length),r=(r=i+(n+10)+r).substring(0,r.length-6),r+='<text x="2" y="'+(n+10-4)+'">geet-gatiroop.com</text></svg>'}else{var o=t.viewBox.baseVal;e.width=o.width,e.height=o.height+10,e.height+=10;var i='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+o.width+" ";r=r.substring(i.length+o.height.toString().length),r=(r=i+(o.height+10)+r).substring(0,r.length-6),r+='<text x="2" y="'+(o.height+10-4)+'">geet-gatiroop.com</text></svg>'}var s=window.URL||window.webkitURL||window,l=new Image,c=new Blob([r],{type:"image/svg+xml"}),h=s.createObjectURL(c);l.onload=function(){e.getContext("2d").drawImage(l,0,0),s.revokeObjectURL(h);var t=e.toDataURL("image/png").replace("image/png","octet/stream"),r=document.createElement("a");document.body.appendChild(r),r.style="display: none",r.href=t,r.download="geetgatiroop-output.png",r.click(),window.URL.revokeObjectURL(t),document.body.removeChild(r)},l.src=h}